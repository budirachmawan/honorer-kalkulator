<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HONORER DIGITAL V5.0 (LOCKED)</title>
<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- CHART JS (Safe Load) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ICONS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
/* ===== DESIGN SYSTEM ===== */
:root {
  --primary: #fbbf24;
  --primary-dark: #b45309;
  --primary-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
  --success: #10b981;
  --success-dark: #047857;
  --success-bg: #ecfdf5;
  --danger: #ef4444;
  --danger-bg: #fef2f2;
  --info: #3b82f6;
  --info-bg: #eff6ff;
  --warning: #f59e0b;
  --bg-body: #f8fafc;
  --bg-card: #ffffff;
  --text-main: #0f172a;
  --text-muted: #64748b;
  --text-light: #94a3b8;
  --border: #e2e8f0;
  --radius-xl: 24px;
  --radius-lg: 16px;
  --shadow-soft: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
  --shadow-float: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
}

* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent; 
  outline: none; 
}

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  margin: 0;
  padding: 20px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.app-container {
  max-width: 900px;
  width: 100%;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr;
  gap: 24px;
}

@media (min-width: 768px) {
  .app-container { 
    grid-template-columns: 400px 1fr; 
    align-items: start; 
  }
}

/* ===== HEADER ===== */
header { 
  text-align: center; 
  margin-bottom: 20px; 
  animation: fadeInDown 0.6s ease-out; 
}
.brand-title { 
  font-size: 28px; 
  font-weight: 800; 
  letter-spacing: -0.05em; 
  color: var(--text-main); 
  margin: 0; 
}
.brand-gold { 
  background: var(--primary-gradient); 
  -webkit-background-clip: text; 
  -webkit-text-fill-color: transparent; 
}

.api-badge {
  display: inline-flex; 
  align-items: center; 
  gap: 6px; 
  padding: 6px 12px;
  background: var(--bg-card); 
  border: 1px solid var(--border); 
  border-radius: 50px;
  font-size: 11px; 
  font-weight: 700; 
  color: var(--text-muted); 
  margin-top: 12px; 
  box-shadow: var(--shadow-soft);
}
.status-dot { 
  width: 8px; 
  height: 8px; 
  border-radius: 50%; 
  background-color: var(--text-light); 
  transition: background 0.3s; 
}
.status-dot.online { 
  background-color: var(--success); 
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); 
}

/* ===== CARDS ===== */
.card {
  background: var(--bg-card); 
  border-radius: var(--radius-xl); 
  padding: 28px;
  box-shadow: var(--shadow-soft); 
  border: 1px solid rgba(255,255,255,0.8);
  position: relative; 
  overflow: hidden;
}
.slide-up { 
  animation: slideUp 0.7s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; 
  opacity: 0; 
  transform: translateY(20px); 
}

/* ===== INPUTS ===== */
.form-group { 
  margin-bottom: 24px; 
  position: relative; 
}
.form-label { 
  font-size: 12px; 
  font-weight: 700; 
  text-transform: uppercase; 
  letter-spacing: 0.5px; 
  color: var(--text-muted); 
  margin-bottom: 8px; 
  display: block; 
}
.required-mark { 
  color: var(--danger); 
  margin-left: 2px; 
}
.optional-tag { 
  font-size: 10px; 
  font-weight: 400; 
  color: var(--text-light); 
  text-transform: none; 
  margin-left: 6px; 
  letter-spacing: 0; 
}

.input-wrapper { 
  position: relative; 
}
/* OPTIMIZED INPUT STYLING */
.form-input {
  width: 100%; 
  padding: 12px 0; 
  font-size: 16px; 
  font-family: inherit;
  color: var(--text-main); 
  background: transparent; 
  border: none;
  border-bottom: 2px solid var(--border); 
  border-radius: 0;
  transition: all 0.3s ease;
}
/* Use inputmode for numeric keyboard on mobile */
.form-input[inputmode="numeric"] {
  -moz-appearance: textfield;
}
.form-input::-webkit-outer-spin-button,
.form-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.form-input:focus, 
.form-select:focus { 
  border-bottom-color: var(--primary); 
  background: linear-gradient(to top, rgba(251, 191, 36, 0.05), transparent); 
}
.form-select { 
  width: 100%; 
  padding: 12px 0; 
  font-size: 16px; 
  font-family: inherit;
  color: var(--text-main); 
  background: transparent; 
  border: none;
  border-bottom: 2px solid var(--border); 
  border-radius: 0;
  transition: all 0.3s ease;
  appearance: none; 
  cursor: pointer; 
}
.select-arrow { 
  position: absolute; 
  right: 0; 
  top: 14px; 
  pointer-events: none; 
  color: var(--primary); 
  font-size: 12px; 
}
.input-row { 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 20px; 
}

/* Toggle Switch */
.switch-container { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  margin-top: 10px; 
}
.switch { 
  position: relative; 
  display: inline-block; 
  width: 44px; 
  height: 24px; 
}
.switch input { 
  opacity: 0; 
  width: 0; 
  height: 0; 
}
.slider { 
  position: absolute; 
  cursor: pointer; 
  top: 0; 
  left: 0; 
  right: 0; 
  bottom: 0; 
  background-color: #ccc; 
  transition: .4s; 
  border-radius: 34px; 
}
.slider:before { 
  position: absolute; 
  content: ""; 
  height: 18px; 
  width: 18px; 
  left: 3px; 
  bottom: 3px; 
  background-color: white; 
  transition: .4s; 
  border-radius: 50%; 
}
input:checked + .slider { 
  background-color: var(--primary); 
}
input:checked + .slider:before { 
  transform: translateX(20px); 
}

/* DREAM CARD DARK THEME - FIXED TEXT COLOR */
.dream-card {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
  color: white;
  padding: 24px; 
  border-radius: var(--radius-lg); 
  margin-bottom: 24px;
  box-shadow: var(--shadow-float); 
  border: 1px solid #334155;
}
.dream-card label { 
  color: #94a3b8; 
}
.dream-card .form-input, 
.dream-card .form-select {
  background: rgba(255,255,255,0.05); 
  border-bottom-color: rgba(255,255,255,0.2); 
  color: white !important;
}
.dream-card .form-select option {
  color: #0f172a !important;
  background: white;
}
.dream-card .form-input:focus, 
.dream-card .form-select:focus {
  background: rgba(255,255,255,0.1); 
  border-bottom-color: var(--primary);
}
.dream-title { 
  font-weight: 700; 
  color: var(--primary); 
  font-size: 14px; 
  margin-bottom: 16px; 
  display: block; 
}

/* ===== BUTTONS ===== */
.btn-main {
  width: 100%; 
  padding: 18px; 
  border: none; 
  border-radius: var(--radius-lg);
  background: var(--primary-gradient); 
  color: white; 
  font-size: 16px; 
  font-weight: 800;
  font-family: inherit; 
  cursor: pointer; 
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 10px 20px -5px rgba(217, 119, 6, 0.4);
  display: flex; 
  justify-content: center; 
  align-items: center;
  gap: 8px;
}
.btn-main:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 15px 25px -5px rgba(217, 119, 6, 0.5); 
}
.btn-main:active { 
  transform: translateY(0); 
}
.btn-secondary {
  width: 100%; 
  padding: 14px; 
  background: white; 
  color: var(--text-muted);
  border: 2px solid var(--border); 
  border-radius: var(--radius-lg); 
  font-weight: 700;
  cursor: pointer; 
  margin-top: 12px; 
  transition: 0.2s;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}
.btn-secondary:hover { 
  border-color: var(--text-main); 
  color: var(--text-main); 
}

/* NEW BACK TO CALCULATOR BUTTON */
.btn-back {
  width: 100%; 
  padding: 14px; 
  background: white; 
  color: var(--info);
  border: 2px solid var(--info); 
  border-radius: var(--radius-lg); 
  font-weight: 700;
  cursor: pointer; 
  margin-top: 12px; 
  transition: 0.2s;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}
.btn-back:hover { 
  background: var(--info-bg); 
  transform: translateY(-2px); 
}

/* ===== RESULT SECTION ===== */
.result-hero { 
  text-align: center; 
  margin-bottom: 30px; 
  padding-bottom: 20px; 
  border-bottom: 1px dashed var(--border); 
}
.hero-label { 
  font-size: 11px; 
  text-transform: uppercase; 
  letter-spacing: 1.5px; 
  color: var(--text-muted); 
  margin-bottom: 8px; 
  font-weight: 700; 
}
.hero-value { 
  font-size: 42px; 
  font-weight: 900; 
  color: var(--text-main); 
  line-height: 1; 
  letter-spacing: -1.5px; 
}
.hero-sub { 
  font-size: 14px; 
  color: var(--success); 
  font-weight: 600; 
  margin-top: 8px; 
  display: inline-block; 
  background: var(--success-bg); 
  padding: 4px 12px; 
  border-radius: 20px; 
}

/* FIXED CHART CONTAINER */
.chart-wrapper { 
  position: relative; 
  height: 250px; 
  width: 100%; 
  margin-bottom: 24px; 
  min-height: 250px;
  max-height: 250px;
}

.info-grid { 
  display: grid; 
  grid-template-columns: 1fr; 
  gap: 16px; 
}
.info-box {
  background: #f8fafc; 
  padding: 16px; 
  border-radius: var(--radius-lg);
  border: 1px solid transparent; 
  transition: 0.2s;
}
.info-box:hover { 
  border-color: var(--border); 
  background: white; 
}
.info-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 8px; 
}
.info-title { 
  font-size: 12px; 
  font-weight: 700; 
  color: var(--text-muted); 
  text-transform: uppercase; 
}
.info-tag { 
  font-size: 10px; 
  padding: 4px 8px; 
  border-radius: 4px; 
  font-weight: 700; 
  background: rgba(0,0,0,0.05); 
}
.info-price { 
  font-size: 20px; 
  font-weight: 800; 
  color: var(--text-main); 
  letter-spacing: -0.5px; 
  margin-top:4px; 
}
.info-desc { 
  font-size: 13px; 
  color: var(--text-muted); 
  line-height: 1.5; 
  margin-top: 4px; 
}

.tag-warning { 
  background: #fffbeb; 
  color: var(--warning); 
  border: 1px solid #fcd34d; 
}
.tag-success { 
  background: var(--success-bg); 
  color: var(--success); 
}
.tag-info { 
  background: var(--info-bg); 
  color: var(--info); 
}

/* IMPROVED GAMIFICATION PROGRESS */
.progress-container { 
  margin-top: 10px; 
}
.progress-labels { 
  display: flex; 
  justify-content: space-between; 
  font-size: 11px; 
  color: var(--text-muted); 
  margin-bottom: 4px; 
}
.progress-track { 
  height: 8px; 
  background: #e2e8f0; 
  border-radius: 4px; 
  overflow: hidden; 
}
.progress-fill { 
  height: 100%; 
  background: var(--primary-gradient); 
  width: 0%; 
  transition: width 1s ease; 
}
.progress-gap {
  font-size: 10px;
  color: var(--text-muted);
  text-align: center;
  margin-top: 4px;
  font-weight: 600;
}

/* IMPROVED LIST STYLING */
.budget-list { 
  list-style: none; 
  padding: 0; 
  margin: 10px 0 0 0; 
}
.budget-list li { 
  font-size: 13px; 
  color: var(--text-muted); 
  margin-bottom: 4px; 
  padding-left: 8px; 
  position: relative; 
}
.budget-list li::before { 
  content: ""; 
  position: absolute; 
  left: 0; 
  top: 8px;
  width: 4px;
  height: 4px;
  background-color: var(--primary); 
  border-radius: 50%;
}

/* IMPROVED ADVICE SECTION */
.advice-card {
  background: #fff; 
  border: 1px solid var(--border); 
  padding: 16px; 
  border-radius: var(--radius-lg);
  margin-bottom: 16px; 
  box-shadow: var(--shadow-soft);
}
.advice-title { 
  font-weight: 700; 
  margin-bottom: 12px; 
  font-size: 14px; 
  display: flex;
  align-items: center;
  gap: 8px;
}
.advice-list { 
  font-size: 13px; 
  line-height: 1.6; 
  color: var(--text-main); 
  font-weight: 500; 
  padding-left: 0;
  margin: 0;
}
.advice-list li { 
  margin-bottom: 8px; 
  padding-left: 0;
  position: relative; 
  list-style: none;
  display: flex;
  align-items: flex-start;
  gap: 8px;
}
.advice-list li i {
  color: var(--success);
  font-size: 12px;
  margin-top: 2px;
  flex-shrink: 0;
}

/* Hustle Tags */
.hustle-container { 
  margin-top: 10px; 
  display: flex; 
  flex-wrap: wrap; 
  gap: 8px; 
}
.hustle-tag {
  font-size: 10px; 
  background: white; 
  border: 1px solid var(--primary); 
  color: var(--primary-dark);
  padding: 4px 10px; 
  border-radius: 20px; 
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

/* IMPROVED DREAM RESULT SPECIFICS */
.dream-result-card {
  background: white; 
  border: 1px solid var(--border); 
  padding: 16px; 
  border-radius: var(--radius-lg);
  margin-bottom: 16px; 
  box-shadow: var(--shadow-soft);
}
.dream-status-badge {
  display: inline-block; 
  padding: 6px 12px; 
  border-radius: 8px; 
  font-weight: 800; 
  text-transform: uppercase; 
  font-size: 12px; 
  margin-top: 10px; 
  width: 100%; 
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.status-success { 
  background: var(--success-bg); 
  color: var(--success); 
}
.status-fail { 
  background: var(--danger-bg); 
  color: var(--danger); 
}
.status-danger { 
  background: #7f1d1d; 
  color: white; 
  border: 1px solid #991b1b; 
}

/* Executive Summary */
.summary-text { 
  font-size: 13px; 
  line-height: 1.6; 
  color: var(--text-main); 
  margin-bottom: 12px; 
}
.summary-heading { 
  font-size: 11px; 
  font-weight: 700; 
  text-transform: uppercase; 
  color: var(--primary-dark); 
  margin-bottom: 6px; 
}
.solution-list { 
  list-style: none; 
  padding: 0; 
  margin: 0;
}
.solution-list li { 
  margin-bottom: 10px; 
  font-weight: 500; 
  line-height: 1.5;
  display: flex;
  align-items: flex-start;
  gap: 8px;
  font-size: 13px !important;
  line-height: 1.5 !important;
  font-family: 'Plus Jakarta Sans', sans-serif !important;
}
.solution-number {
  font-weight: 800;
  color: var(--primary);
  flex-shrink: 0;
}
.solution-icon {
  color: var(--primary);
  font-size: 14px;
  margin-top: 3px;
  flex-shrink: 0;
}

/* IMPROVED ACCOUNTING BOX STYLE */
.acc-box {
  background: var(--text-main); 
  color: white; 
  padding: 16px; 
  border-radius: var(--radius-lg);
  margin-top: 16px; 
  border: 1px solid #334155;
}
.acc-row {
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  margin-bottom: 8px; 
  font-size: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.1); 
  padding-bottom: 8px;
}
.acc-row:last-child { 
  border-bottom: none; 
}
.acc-label { 
  font-weight: 500; 
  color: #cbd5e1; 
  font-size: 13px; 
  flex: 1;
}
.acc-val { 
  font-weight: 800; 
  color: #fff; 
  font-size: 15px; 
  letter-spacing: -0.5px;
  text-align: right;
  flex: 1;
}
.acc-val.neg { 
  color: #fca5a5; 
}
.acc-val.pos { 
  color: #34d399; 
}
.acc-divider { 
  border-top: 1px dashed rgba(255,255,255,0.3); 
  margin-top: 4px; 
  padding-top: 8px; 
  font-weight: 700; 
  text-transform: uppercase; 
  font-size: 11px; 
  letter-spacing: 1px; 
  text-align: center;
}

/* Locked / Donate Section */
.locked-section {
  margin-top: 24px; 
  padding: 24px; 
  border: 2px dashed var(--border);
  background: #fff; 
  border-radius: var(--radius-xl); 
  text-align: center;
}

/* IMPROVED PRODUCT CARDS WITH ICONS */
.product-grid { 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 12px; 
  margin-top: 20px; 
}
.product-card {
  background: white; 
  border: 1px solid var(--border); 
  padding: 20px 16px;
  border-radius: var(--radius-lg); 
  text-decoration: none; 
  color: inherit;
  display: block; 
  transition: 0.2s;
  text-align: left;
}
.product-card:hover { 
  transform: translateY(-3px); 
  border-color: var(--primary); 
  box-shadow: var(--shadow-soft); 
}
.product-icon {
  font-size: 24px;
  margin-bottom: 8px;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 8px;
}
.product-title { 
  font-weight: 700; 
  margin-top: 4px; 
  font-size: 14px; 
  color: var(--text-main); 
  display: flex;
  align-items: center;
  gap: 6px;
}
.product-desc { 
  font-size: 11px; 
  color: var(--text-muted); 
  margin-bottom: 8px; 
  line-height: 1.3; 
}

/* Buttons */
.btn-donate, .btn-consult {
  display: inline-block; 
  width: 100%; 
  padding: 12px; 
  margin-bottom: 8px; 
  border: none;
  border-radius: 8px; 
  font-weight: 700; 
  font-size: 13px;
  text-decoration: none; 
  transition: 0.2s; 
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.btn-donate {
  background: var(--primary-gradient); 
  color: white; 
  box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
}
.btn-consult {
  background: white; 
  color: var(--info); 
  border: 1px solid var(--info);
}
.btn-donate:hover { 
  box-shadow: 0 6px 15px rgba(245, 158, 11, 0.5); 
  transform: translateY(-2px); 
}
.btn-consult:hover { 
  background: var(--info-bg); 
  transform: translateY(-2px); 
}

.hidden { 
  display: none !important; 
}

/* GOLD PRICE INFO */
.gold-price-info {
  font-size: 11px;
  color: var(--text-muted);
  text-align: center;
  margin-top: 4px;
  padding: 4px 8px;
  background: var(--info-bg);
  border-radius: 4px;
  border-left: 3px solid var(--info);
}
.gold-price-info i {
  color: var(--warning);
  margin-right: 4px;
}

/* ANALOGI PERJALANAN STYLE */
.analogy-box {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 1px solid #bae6fd;
  padding: 16px;
  border-radius: var(--radius-lg);
  margin-top: 16px;
  font-size: 13px;
  line-height: 1.6;
}
.analogy-title {
  font-weight: 700;
  color: #0369a1;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.analogy-point {
  margin-bottom: 8px;
  padding-left: 16px;
  position: relative;
}
.analogy-point::before {
  content: "â€¢";
  position: absolute;
  left: 0;
  color: #0284c7;
  font-weight: bold;
}

/* Footer */
.app-footer {
  margin-top: 24px;
  text-align: center;
  font-size: 11px;
  color: var(--text-light);
  padding: 12px;
  border-top: 1px solid var(--border);
  width: 100%;
}

/* Mobile Optimization */
@media (max-width: 768px) {
  .app-container {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .card {
    padding: 20px;
  }
  
  .input-row {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  /* Make button more accessible on mobile */
  .btn-main {
    position: relative;
    margin-top: 8px;
  }
  
  /* Adjust font sizes for mobile */
  .hero-value {
    font-size: 36px;
  }
  
  .chart-wrapper {
    height: 220px;
    min-height: 220px;
    max-height: 220px;
  }
  
  /* Better touch targets */
  .form-input, .form-select {
    padding: 14px 0;
    font-size: 16px;
  }
  
  .product-grid {
    grid-template-columns: 1fr;
  }
}

@keyframes fadeInDown { 
  from { 
    opacity: 0; 
    transform: translateY(-20px); 
  } 
  to { 
    opacity: 1; 
    transform: translateY(0); 
  } 
}
@keyframes slideUp { 
  from { 
    opacity: 0; 
    transform: translateY(30px); 
  } 
  to { 
    opacity: 1; 
    transform: translateY(0); 
  } 
}
</style>
</head>
<body>

<div class="app-container">
  
  <!-- LEFT COLUMN: INPUT -->
  <div class="card slide-up" id="input-section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
      <h3 style="margin:0; font-size:18px; font-weight:800;">Data Keuangan</h3>
      <div id="apiStatus" class="api-badge"><span class="status-dot"></span> <span id="api-text">Checking...</span></div>
    </div>

    <div class="input-row form-group">
      <div>
        <label class="form-label">Gaji Pokok <span class="required-mark">*</span></label>
        <input class="form-input" type="text" id="gajiPokok" placeholder="Contoh: 5.000.000" inputmode="numeric" autocomplete="off">
      </div>
      <div>
        <label class="form-label">Side Hustle <span class="optional-tag">(Opsional)</span></label>
        <input class="form-input" type="text" id="sideHustle" placeholder="Contoh: 1.000.000" inputmode="numeric" autocomplete="off">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Status Saat Ini</label>
      <div class="input-wrapper">
        <select class="form-select" id="status">
          <option value="nikah">Akan Menikah</option>
          <option value="hamil">Persiapan Hamil</option>
          <option value="anak">Sudah Punya Anak</option>
        </select>
        <span class="select-arrow">â–¼</span>
      </div>
    </div>

    <!-- Target Tanggal -->
    <div class="form-group">
      <label class="form-label">Target Tanggal Pencapaian <span class="optional-tag">(Opsional)</span></label>
      <input class="form-input" type="date" id="targetDate" style="color: var(--text-muted);">
      <div style="font-size:11px; color:var(--text-light); margin-top:6px;">Contoh: Tanggal rencana nikah / target tabungan.</div>
      
      <div class="switch-container">
        <span style="font-size:11px; font-weight:700; color:var(--text-muted);">Kalkulasi Inflasi (Est. 6% / thn)</span>
        <label class="switch">
          <input type="checkbox" id="inflationToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="input-row form-group">
      <div>
        <label class="form-label">Gaya Hidup</label>
        <div class="input-wrapper">
          <select class="form-select" id="lifestyle">
            <option value="hemat">Hemat (Frugal)</option>
            <option value="standar" selected>Standar</option>
            <option value="mewah">Mewah</option>
          </select>
          <span class="select-arrow">â–¼</span>
        </div>
      </div>
      <div>
        <label class="form-label">Total Utang <span class="optional-tag">(Opsional)</span></label>
        <input class="form-input" type="text" id="debt" placeholder="Contoh: 500.000" inputmode="numeric" autocomplete="off">
        <div style="font-size:10px; color:var(--text-light); margin-top:4px;">Isikan total utang bulanan Anda</div>
      </div>
    </div>

    <!-- Tabungan Saat Ini -->
    <div class="form-group">
      <label class="form-label">Tabungan Saat Ini <span class="optional-tag">(Opsional)</span></label>
      <input class="form-input" type="text" id="currentSavings" placeholder="Contoh: 2.000.000" inputmode="numeric" autocomplete="off" style="color:var(--primary);">
      <div style="font-size:10px; color:var(--text-light); margin-top:4px;">Wajib diisi untuk Akuntansi.</div>
    </div>

    <!-- DREAM CARD - FIXED TEXT COLOR -->
    <div class="dream-card">
      <div class="dream-header">
        <span class="dream-title">DREAM PLANNER (Opsional)</span>
      </div>
      <div class="input-row" style="margin-bottom:12px;">
        <div class="input-wrapper" style="flex:2;">
          <select class="form-select" id="dreamType">
            <option value="none">-- Pilih Aset --</option>
            <option value="rumah">Rumah / KPR</option>
            <option value="motor">Motor</option>
            <option value="mobil">Mobil</option>
            <option value="haji">Daftar Haji</option>
            <option value="gadget">Gadget</option>
            <option value="liburan">Liburan</option>
          </select>
        </div>
        <div class="input-wrapper" style="flex:1;">
          <select class="form-select" id="dreamMethod">
            <option value="tunai">Tunai</option>
            <option value="kredit">Kredit (Cicilan)</option>
          </select>
        </div>
      </div>
      
      <div id="dpContainer" class="hidden" style="margin-bottom: 12px; border-bottom: 1px dashed rgba(255,255,255,0.2); padding-bottom:12px;">
        <label class="form-label" style="color:#94a3b8;">Uang Muka (DP) %</label>
        <input class="form-input" type="number" id="dpPercent" value="20" min="10" max="90" style="padding: 8px 0; font-size: 14px;" inputmode="numeric">
        
        <!-- IMPROVED CREDIT INPUTS -->
        <div class="input-row" style="margin-top:12px;">
          <div>
            <label class="form-label" style="color:#94a3b8; font-size:10px;">Tenor (Tahun)</label>
            <select class="form-select" id="tenorYears" style="padding: 8px 0; font-size: 14px;">
              <option value="1">1 Tahun</option>
              <option value="2">2 Tahun</option>
              <option value="3" selected>3 Tahun</option>
              <option value="4">4 Tahun</option>
              <option value="5">5 Tahun</option>
              <option value="10">10 Tahun</option>
              <option value="15">15 Tahun</option>
              <option value="20">20 Tahun</option>
            </select>
          </div>
          <div>
            <label class="form-label" style="color:#94a3b8; font-size:10px;">Bunga (%/thn)</label>
            <input class="form-input" type="number" id="interestRate" value="12" min="1" max="30" style="padding: 8px 0; font-size: 14px;" inputmode="numeric">
          </div>
        </div>
      </div>

      <input class="form-input" type="text" id="dreamPrice" placeholder="Estimasi Harga Cash (Rp)" inputmode="numeric" autocomplete="off" style="margin-bottom: 0;">
    </div>

    <button class="btn-main" id="btn-calc" onclick="hitung()">
      <i class="fas fa-calculator"></i>
      <span id="btn-text">ANALISIS KEAMANAN SAYA</span>
    </button>
    <button class="btn-secondary hidden" id="unlock-btn" onclick="unlockForm()">
      <i class="fas fa-edit"></i>
      <span>Edit Data Ulang</span>
    </button>
    
    <!-- NEW BACK BUTTON -->
    <button class="btn-back hidden" id="back-btn" onclick="goBackToCalculator()">
      <i class="fas fa-arrow-left"></i>
      <span>Kembali ke Dashboard</span>
    </button>
  </div>

  <!-- RIGHT COLUMN: RESULT -->
  <div class="card slide-up" style="animation-delay: 0.2s;" id="result-section">
    
    <div class="result-hero">
      <div class="hero-label">Total Aset Aman Tercatat</div>
      <div class="hero-value" id="emas">0 gram</div>
      <div class="hero-sub">Dana yang bisa dikunci ke emas</div>
      <div class="gold-price-info" id="gold-info">
        <i class="fas fa-sync-alt"></i> Harga emas diupdate otomatis setiap 2 menit
      </div>
    </div>

    <div class="chart-wrapper">
      <canvas id="chart"></canvas>
    </div>

    <!-- HIDDEN BY DEFAULT (LOCKED) -->
    <div id="detail-container" class="hidden">
      
      <!-- IMPROVED GAMIFICATION -->
      <div id="gamification-wrapper" class="info-box" style="background:var(--info-bg); border-color:var(--info);">
        <div class="info-header">
          <div class="info-title" style="color:var(--info);">
            <i class="fas fa-chart-line"></i>
            Progres Perjalanan Finansial
          </div>
          <span class="info-tag" style="background:var(--info); color:white;">Level Up</span>
        </div>
        <div style="font-size:12px; margin-bottom:4px;">Target: <span id="prog-target">Rp 0</span> | Terkumpul: <span id="prog-current">Rp 0</span></div>
        <div class="progress-container">
          <div class="progress-track"><div class="progress-fill" id="prog-bar"></div></div>
        </div>
        <div style="text-align:center; font-size:11px; font-weight:700; color:var(--text-main); margin-top:8px;">
          <div>Jarak ke target: <span id="prog-percent">0%</span></div>
          <div class="progress-gap" id="prog-gap">Kurang 100% untuk mencapai target</div>
        </div>
      </div>

      <!-- DREAM RESULT -->
      <div id="dream-result-wrapper"></div>

      <!-- ANALISA BULANAN - FIXED LOGIC -->
      <div class="info-box" id="monthly-analysis-card">
        <div class="info-header">
          <div class="info-title" style="color:var(--info);">
            <i class="fas fa-money-bill-wave"></i>
            Pembagian Penghasilan Bulanan
          </div>
          <span class="info-tag tag-info">Prioritas Keuangan</span>
        </div>
        <div style="font-size:13px; margin-bottom:8px; font-weight:600;">Total Penghasilan: <span id="cash-income" style="color:var(--text-main);">Rp 0</span></div>
        
        <!-- FIXED: 70% untuk Dana Penyangga Hidup -->
        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; color:var(--text-muted);">
          <span><i class="fas fa-shield-alt"></i> Dana Penyangga Hidup</span>
          <span id="cash-needs">0 (70%)</span>
        </div>
        
        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; color:var(--text-muted);">
          <span><i class="fas fa-file-invoice"></i> Cicilan Utang</span>
          <span id="cash-debt">0 (0%)</span>
        </div>
        
        <div style="display:flex; justify-content:space-between; font-size:13px; margin-top:8px; border-top:1px dashed var(--border); padding-top:8px;">
          <span style="font-weight:700;"><i class="fas fa-piggy-bank"></i> Sisa untuk Tabungan</span>
          <span id="cash-save" style="font-weight:800; color:var(--success);">0 (0%)</span>
        </div>
        
        <div style="margin-top:12px; padding:8px; background:#f0f9ff; border-radius:6px; border-left:3px solid #0ea5e9;">
          <div style="font-size:11px; font-weight:700; color:#0369a1; margin-bottom:4px;">ðŸ“‹ LOGIKA PRIORITAS:</div>
          <div style="font-size:10px; color:#0c4a6e; line-height:1.4;">
            1. Dana Penyangga (70%) â†’ 2. Lunasi Utang â†’ 3. Tabungan â†’ 4. Dana Aman (Emas)
          </div>
        </div>
      </div>

      <!-- DETAILED CARDS -->
      <div class="info-grid" style="margin-top:16px;">
        
        <!-- Card A: Penyangga -->
        <div class="info-box">
          <div class="info-header">
            <div class="info-title">
              <i class="fas fa-shield-alt"></i>
              Dana Darurat 3 Bulan
            </div>
            <span class="info-tag tag-warning">PRIORITAS 1</span>
          </div>
          <div class="info-price" id="buffer-price">Rp 0</div>
          <div class="info-desc">
            <strong>Bukan untuk ditabung!</strong> Ini uang darurat yang harus siap di rekening.
            <div style="margin-top:8px; font-size:11px; color:var(--warning);">
              <i class="fas fa-info-circle"></i> 70% dari gaji = kebutuhan hidup bulanan. 
              Dana ini adalah 3x kebutuhan hidup (jaga-jaga kalau tiba-tiba butuh).
            </div>
            <div style="margin-top:4px; font-size:11px; color:var(--text-muted);">
              Contoh: Gaji Rp 5jt â†’ Kebutuhan Rp 3,5jt/bulan â†’ Dana darurat = Rp 10,5jt
            </div>
          </div>
        </div>

        <!-- Card B: Kebutuhan Dana Besar (10 Items) -->
        <div class="info-box">
          <div class="info-header">
            <div class="info-title">
              <i class="fas fa-bullseye"></i>
              Kebutuhan Dana Besar
            </div>
            <span class="info-tag" id="lifestyle-tag-detail">Standar</span>
          </div>
          <div class="info-price" id="target-price-detail">Rp 0</div>
          <div id="inflation-alert"></div>
          <div class="info-desc">Estimasi biaya realistis dengan gaya hidup <span id="lifestyle-text">Standar</span>.</div>
          <ul class="budget-list" id="budget-list-items"></ul>
        </div>

        <!-- Card C: Dana Siap Dikunci -->
        <div class="info-box" style="background: var(--success-bg); border-color: #a7f3d0;">
          <div class="info-header">
            <div class="info-title">
              <i class="fas fa-lock"></i>
              Dana Siap Dikunci
            </div>
            <span class="info-tag tag-success">PRIORITAS 4</span>
          </div>
          <div class="info-price" style="color: var(--success-dark);" id="safe-price-detail">Rp 0</div>
          <div class="info-desc">Sisa dana setelah Dana Penyangga dan Kebutuhan Besar.</div>
          <div style="margin-top:12px; font-size:12px; font-weight:700; color:var(--success-dark);">
            <i class="fas fa-gem"></i> Setara emas: <span id="gram-detail">0</span> gram
          </div>
          <div style="font-size:12px; color:var(--success-dark);">
            <i class="fas fa-coins"></i> Harga emas: <span id="gold-price-detail">Rp 0</span> / gram
          </div>
          <div class="gold-price-info" style="margin-top:8px; font-size:10px;">
            <i class="fas fa-info-circle"></i> Data harga emas dari API Antam, update otomatis
          </div>
        </div>

      </div>

      <!-- IMPROVED ACCOUNTING SUMMARY -->
      <div id="accounting-wrapper" class="acc-box">
        <div style="text-align:center; margin-bottom:16px; font-weight:700; letter-spacing:1px; text-transform:uppercase;">
          <i class="fas fa-balance-scale"></i> Neraca Keuangan
        </div>
        
        <div class="acc-row">
          <div class="acc-label">Total Aset Lancar</div>
          <div class="acc-val" id="total-aset">Rp 0</div>
        </div>
        <div style="font-size:9px; color:#cbd5e1; text-align:right; padding:0 0 4px 0; font-weight:normal;">
          (Tabungan + Dana Darurat 3 bulan)
        </div>

        <div class="acc-row">
          <div class="acc-label">Total Kewajiban</div>
          <div class="acc-val" id="total-kewajiban">Rp 0</div>
        </div>
        <div style="font-size:9px; color:#cbd5e1; text-align:right; padding:0 0 4px 0; font-weight:normal;">
          (Target Dana Besar + Utang tahunan)
        </div>

        <div class="acc-row">
          <div class="acc-label">Ekuitas (Kekayaan Bersih)</div>
          <div class="acc-val" id="ekuitas">Rp 0</div>
        </div>
        <div style="font-size:9px; color:#cbd5e1; text-align:right; padding:0 0 4px 0; font-weight:normal;">
          (Aset - Kewajiban)
        </div>

        <div class="acc-row acc-divider">
          <div class="acc-label">RASIO KEUANGAN</div>
          <div class="acc-val" id="rasio-keuangan">0.00</div>
        </div>
        <div style="font-size:10px; color:#cbd5e1; text-align:center; margin-top:4px; padding:0 8px;">
          <span id="rasio-explanation">Rasio Aset/Kewajiban = Kesehatan Keuangan</span>
        </div>
      </div>

      <!-- ANALOGI PERJALANAN -->
      <div id="analogy-wrapper" class="analogy-box">
        <div class="analogy-title">
          <i class="fas fa-road"></i>
          Kondisi Keuanganmu Saat Ini
        </div>
        <div id="analogy-content">
          Silakan isi data untuk melihat kondisi keuangan Anda.
        </div>
      </div>

      <!-- IMPROVED SOLUTION LIST -->
      <div id="solution-wrapper" class="info-box" style="background:white; border: 1px solid var(--primary);">
        <div class="info-header">
          <div class="info-title" style="color:var(--primary-dark);">
            <i class="fas fa-lightbulb"></i>
            Solusi & Rekomendasi
          </div>
        </div>
        <ul class="solution-list" id="solution-list-content"></ul>
        <div id="side-hustle-recommendations"></div>
      </div>

      <!-- STRATEGI CERDAS (SIDE HUSTLE) -->
      <div id="strategy-wrapper"></div>

      <!-- TARGET PLAN -->
      <div id="target-plan-card" class="info-box" style="margin-top:16px; background: white; border: 2px solid var(--primary);">
        <div class="info-header">
          <div class="info-title" style="color:var(--primary-dark);">
            <i class="fas fa-calendar-alt"></i>
            Target Tanggal
          </div>
          <span class="info-tag" style="background:var(--primary-gradient); color:white;">Hitung Mundur</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
          <div style="font-weight:700;">Target Tanggal:</div>
          <div id="plan-date">-</div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
          <div style="font-weight:700;">Sisa Waktu:</div>
          <div id="plan-months" style="color:var(--danger); font-weight:800;">0 Bulan</div>
        </div>
        
        <div style="background:#fffbeb; padding:12px; border-radius:8px; border:1px solid #fcd34d; margin-bottom:12px;">
          <div style="font-size:11px; font-weight:800; color:#b45309; margin-bottom:8px; text-transform:uppercase;">
            <i class="fas fa-fire"></i> Langkah Nyata Harian
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:8px;">
            <div style="text-align:center;">
              <div style="font-size:10px; color:#92400e;">Target Harian</div>
              <div style="font-size:14px; font-weight:800; color:#92400e;" id="plan-daily">Rp 0</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:10px; color:#92400e;">Target Mingguan</div>
              <div style="font-size:14px; font-weight:800; color:#92400e;" id="plan-weekly">Rp 0</div>
            </div>
          </div>
          <div style="font-size:11px; color:#b45309; font-style:italic; text-align:center;" id="plan-context">Hemat dari pengeluaran rutin.</div>
        </div>

        <div style="border-top:1px dashed var(--border); padding-top:12px;">
          <span style="font-size:13px; color:var(--text-muted);">Total Bulanan:</span>
          <div style="font-size:18px; font-weight:900; color:var(--text-main);" id="plan-monthly">Rp 0 / bln</div>
          
          <div id="plan-comparison-box" style="margin-top:8px; padding:8px; border-radius:6px; font-size:12px; line-height:1.4;"></div>
        </div>
      </div>

      <!-- IMPROVED NASEHAH HARIAN -->
      <div id="advice-wrapper" class="advice-card">
        <div class="advice-title">
          <i class="fas fa-graduation-cap"></i>
          Nasehat Harianmu
        </div>
        <ul class="advice-list" id="advice-list-content"></ul>
      </div>

      <!-- LOCKED / DONATE / KONSULTASI -->
      <div class="locked-section">
        <h4 style="margin:0 0 4px 0; color:var(--text-main);">Paket Premium</h4>
        <p style="font-size:13px; color:var(--text-muted); margin:0 0 16px 0;">Template Excel & E-Book.</p>
        
        <div class="product-grid">
          <a href="#" id="wa-excel" class="product-card" target="_blank">
            <div class="product-icon">
              <i class="fas fa-file-excel"></i>
              <span>Template Excel</span>
            </div>
            <div class="product-desc">Tabel hitung otomatis lengkap sesuai hasil kalkulator ini.</div>
          </a>
          <a href="#" id="wa-ebook" class="product-card" target="_blank">
            <div class="product-icon">
              <i class="fas fa-book"></i>
              <span>Panduan Emas (E-Book)</span>
            </div>
            <div class="product-desc">Cara beli emas mulia dari gram kecil & tips gadai.</div>
          </a>
        </div>
        
        <a href="#" id="wa-consult" class="btn-consult">
          <i class="fas fa-comments"></i>
          Konsultasi Keuangan
        </a>
        <a href="#" id="wa-donate" class="btn-donate">
          <i class="fas fa-heart"></i>
          Dukung Pengembang
        </a>
        
        <div style="margin-top:12px;">
           <a href="#" id="wa-feedback" style="font-size:12px; color:var(--text-muted); text-decoration:underline;">
             <i class="fas fa-comment-alt"></i> Kirim Kritik & Saran
           </a>
        </div>
        
        <div class="app-footer" style="margin-top:16px; border-top:1px solid var(--border); padding-top:12px;">
          <div style="font-size:10px; color:var(--text-light);">
            Buatan <strong>Honorer Digital</strong> â€¢ Tahun 2026
          </div>
          <div style="font-size:9px; color:var(--text-light); margin-top:4px;">
            Kalkulator Keamanan Finansial v5.0 â€¢ Data harga emas dari API Antam
          </div>
        </div>
      </div>

    </div>

    <!-- Initial State Message -->
    <div id="initial-msg" style="text-align:center; padding: 40px 0; color:var(--text-light);">
      <p>Silakan isi data keuangan Anda di sebelah kiri untuk melihat analisa keamanan finansial.</p>
    </div>

  </div>
</div>

<!-- FOOTER -->
<div class="app-footer">
  <div>Buatan <strong>Honorer Digital</strong> â€¢ Tahun 2026</div>
  <div style="font-size:10px; margin-top:4px;">Kalkulator Keamanan Finansial v5.0 â€¢ Data harga emas dari API Antam</div>
</div>

<script>
// --- UTILITIES ---
const formatIDR = (x) => {
  if(!x || isNaN(x)) return "Rp 0";
  return new Intl.NumberFormat("id-ID").format(x);
};

// --- REAL-TIME INPUT FORMATTING ---
let isFormatting = false;

const formatInputValue = (element) => {
  if (!element || isFormatting) return;
  
  isFormatting = true;
  
  // Save cursor position
  const start = element.selectionStart;
  const end = element.selectionEnd;
  
  // Get raw value and remove all non-digits
  let rawValue = element.value.replace(/[^0-9]/g, "");
  
  // If empty, clear and exit
  if (!rawValue) {
    element.value = "";
    isFormatting = false;
    return;
  }
  
  // Parse to number
  const numValue = parseInt(rawValue, 10);
  
  // Format with thousand separators
  if (!isNaN(numValue)) {
    element.value = numValue.toLocaleString("id-ID");
    
    // Restore cursor position (adjust for added separators)
    const formattedLength = element.value.length;
    
    let newStart = start;
    let newEnd = end;
    
    // Count separators before original cursor position
    let separatorsBeforeStart = 0;
    const textBeforeCursor = element.value.substring(0, Math.min(start, formattedLength));
    separatorsBeforeStart = (textBeforeCursor.match(/\./g) || []).length;
    
    newStart = start + separatorsBeforeStart;
    newEnd = end + separatorsBeforeStart;
    
    // Ensure cursor stays within bounds
    newStart = Math.min(newStart, formattedLength);
    newEnd = Math.min(newEnd, formattedLength);
    
    // Set cursor position
    setTimeout(() => {
      element.setSelectionRange(newStart, newEnd);
      isFormatting = false;
    }, 0);
  } else {
    element.value = "";
    isFormatting = false;
  }
};

// Initialize real-time input formatting
const initializeInputFormatting = () => {
  const numericInputs = ['gajiPokok', 'sideHustle', 'debt', 'dreamPrice', 'currentSavings'];
  
  numericInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      // Format on input (real-time)
      input.addEventListener('input', () => {
        formatInputValue(input);
      });
      
      // Also format on blur
      input.addEventListener('blur', () => {
        formatInputValue(input);
      });
      
      // Set placeholder with formatted example
      if (id === 'gajiPokok') input.placeholder = "Contoh: 5.000.000";
      if (id === 'sideHustle') input.placeholder = "Contoh: 1.000.000";
      if (id === 'debt') input.placeholder = "Contoh: 500.000";
      if (id === 'currentSavings') input.placeholder = "Contoh: 2.000.000";
      if (id === 'dreamPrice') input.placeholder = "Contoh: 50.000.000";
    }
  });
};

// Parse formatted number back to integer
const parseFormattedNumber = (formattedString) => {
  if (!formattedString) return 0;
  // Remove all non-digit characters
  const digitsOnly = formattedString.replace(/[^0-9]/g, "");
  return parseInt(digitsOnly, 10) || 0;
};

// --- VALIDASI INPUT ---
function validateInputs() {
  const gaji = parseFormattedNumber(document.getElementById('gajiPokok').value);
  
  if (gaji < 1000000) {
    alert("Gaji minimal Rp 1.000.000 untuk analisis yang akurat");
    return false;
  }
  
  const savings = parseFormattedNumber(document.getElementById('currentSavings').value);
  if (savings < 0) {
    alert("Tabungan tidak boleh minus");
    return false;
  }
  
  return true;
}

// --- GOLD API LOGIC WITH AUTOMATIC UPDATES ---
let chartInstance = null;
let goldPrice = 1000000; // Default fallback price
let goldUpdateInterval = null;
let goldLastUpdate = null;

async function getHargaEmas(updateUI = false) {
  const badgeText = document.getElementById('api-text');
  const dot = document.querySelector('.status-dot');
  const cacheKey = 'harga_emas_cache_v2'; // Cache key baru
  
  try {
    badgeText.innerText = "Updating...";
    
    // API BARU dari logam-mulia-api.vercel.app
    const response = await fetch("https://logam-mulia-api.vercel.app/api/antam");
    if (!response.ok) throw new Error("API response not OK");
    
    const data = await response.json();
    
    // Validasi response structure
    if (!data || typeof data.buy !== 'number') {
      throw new Error("Invalid API response format");
    }
    
    // Cache the new price
    goldPrice = data.buy;
    goldLastUpdate = new Date();
    localStorage.setItem(cacheKey, JSON.stringify({
      time: Date.now(), 
      price: data.buy,
      source: "API Antam (logam-mulia-api.vercel.app)",
      timestamp: goldLastUpdate.toISOString()
    }));
    
    badgeText.innerText = "LIVE"; 
    dot.classList.add('online');
    
    // Update UI elements with new price
    if (updateUI) {
      updateGoldPriceInUI();
    }
    
    // Log success
    console.log(`âœ… Harga emas updated: Rp ${goldPrice.toLocaleString('id-ID')}`);
    
    return data.buy;
    
  } catch(err) {
    console.log("âŒ Gold API error:", err);
    badgeText.innerText = "OFFLINE"; 
    dot.classList.remove('online');
    
    // Try to get cached data
    const cached = localStorage.getItem(cacheKey);
    if(cached) {
      const cacheData = JSON.parse(cached);
      const cacheAge = Date.now() - cacheData.time;
      
      // Use cache if less than 24 hours old
      if(cacheAge < 24 * 60 * 60 * 1000) {
        goldPrice = cacheData.price;
        goldLastUpdate = new Date(cacheData.time);
        
        if (updateUI) {
          updateGoldPriceInUI();
        }
        return cacheData.price;
      }
    }
    
    // Ultimate fallback
    goldPrice = 1000000;
    goldLastUpdate = new Date();
    
    if (updateUI) {
      updateGoldPriceInUI();
    }
    return goldPrice;
  }
}

function updateGoldPriceInUI() {
  // Update gold price in all relevant places
  const goldPriceElements = document.querySelectorAll('#gold-price-detail, #gold-price-display');
  goldPriceElements.forEach(el => {
    if (el.id === 'gold-price-detail' || el.id === 'gold-price-display') {
      el.textContent = "Rp " + formatIDR(goldPrice);
    }
  });
  
  // Update gold info
  const goldInfo = document.getElementById('gold-info');
  if (goldInfo && goldLastUpdate) {
    const timeAgo = Math.floor((new Date() - goldLastUpdate) / 60000); // minutes ago
    if (timeAgo < 2) {
      goldInfo.innerHTML = `<i class="fas fa-check-circle"></i> Harga emas terkini: Rp ${formatIDR(goldPrice)}/gram`;
    } else {
      goldInfo.innerHTML = `<i class="fas fa-clock"></i> Harga emas: Rp ${formatIDR(goldPrice)}/gram (update ${timeAgo} menit lalu)`;
    }
  }
  
  // Also update gram calculation if we have aman value
  const amanElement = document.getElementById('safe-price-detail');
  if (amanElement) {
    const amanText = amanElement.textContent.replace(/[^0-9]/g, "");
    const amanValue = parseInt(amanText) || 0;
    if (amanValue > 0 && goldPrice > 0) {
      const goldGrams = (amanValue / goldPrice).toFixed(2);
      document.getElementById('gram-detail').textContent = goldGrams + " gram";
      document.getElementById('emas').textContent = goldGrams + " gram";
    }
  }
}

// Start automatic gold price updates (every 2 minutes)
function startGoldPriceUpdates() {
  if (goldUpdateInterval) {
    clearInterval(goldUpdateInterval);
  }
  
  // Update immediately
  getHargaEmas(true);
  
  // Then update every 2 minutes (120,000 ms) untuk lebih real-time
  goldUpdateInterval = setInterval(() => {
    getHargaEmas(true);
  }, 2 * 60 * 1000);
}

// --- IMPROVED CHART RENDERER ---
function renderChart(aman, buffer) {
  const ctx = document.getElementById('chart');
  if(!ctx) return;
  
  try {
    // Destroy previous chart if exists
    if(chartInstance) {
      chartInstance.destroy();
    }
    
    // Create new chart with fixed dimensions
    chartInstance = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Dana Aman (Emas)", "Dana Penyangga (Tunai)"],
        datasets: [{
          data: [aman, buffer],
          backgroundColor: ["#10b981", "#fbbf24"],
          borderWidth: 0, 
          hoverOffset: 4
        }]
      },
      options: {
        cutout: '75%', 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            position: 'bottom', 
            labels: { 
              usePointStyle: true, 
              padding: 20, 
              font: {
                family: 'Plus Jakarta Sans',
                size: 12
              }
            } 
          } 
        },
        animation: { 
          animateScale: true, 
          animateRotate: true,
          duration: 1000
        }
      }
    });
  } catch(e) {
    console.log("Chart Error:", e);
    // Don't let chart crash stop the app
  }
}

// --- DP INPUT TOGGLE ---
document.getElementById('dreamMethod').addEventListener('change', (e) => {
  const dpContainer = document.getElementById('dpContainer');
  if(e.target.value === 'kredit') {
    dpContainer.classList.remove('hidden');
  } else {
    dpContainer.classList.add('hidden');
  }
});

// --- LOAD DATA ---
window.onload = async () => { 
  await getHargaEmas();
  initializeInputFormatting();
  startGoldPriceUpdates();
};

// --- LOCKING ---
function unlockForm() {
  document.getElementById('input-section').classList.remove('hidden');
  document.getElementById('unlock-btn').classList.add('hidden');
  document.getElementById('detail-container').classList.add('hidden');
  document.getElementById('initial-msg').classList.remove('hidden');
  document.getElementById('btn-calc').classList.remove('hidden');
  document.getElementById('back-btn').classList.add('hidden');
}

// --- NEW: BACK TO CALCULATOR FUNCTION ---
function goBackToCalculator() {
  unlockForm();
  // Scroll to top for better UX
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// --- ADVICE DATABASE ---
const adviceDB = {
  nikah: [
    "Utamakan Mahar dalam bentuk Emas.",
    "Gunakan undangan digital.",
    "Catering: Nasi box enak lebih disukai.",
    "Sewa dekorasi 'Backdrop Only'.",
    "Jangan beli semua perlengkapan baru."
  ],
  hamil: [
    "Cek fasilitas kelas 3 BPJS.",
    "Stok Pampers saat promo.",
    "Vitamin dan Nutrisi ibu adalah prioritas.",
    "Tips Hemat Susu: ASI eksklusif.",
    "Jangan terlalu sering USG kosmetik."
  ],
  anak: [
    "Mainan edukasi lebih baik.",
    "Bekal makan dari rumah.",
    "Susu UHT plain lebih baik untuk gigi.",
    "Tukar baju dengan saudara sepupu.",
    "Bimbing belajar sendiri gratis."
  ]
};

// --- HUSTLE DATABASE ---
const hustleDB = {
  rumah: ["Usaha Online", "Warung Kelontong", "Kedai Online", "Renovasi Ringan", "Tukang Kayu", "Agen Properti", "Interior Desain", "Home Cleaning", "Dekorasi", "Katering"],
  motor: ["Ojek Online", "Kurir Barang", "Sales Offline", "Kopi Keliling", "Cuci Motor", "Tambal Ban", "Servis Panggilan", "Titip Jual Part", "Bengkel", "Sparepart Bekas"],
  mobil: ["Kopi Keliling Mobil", "Travel Agent", "Rental Car", "Ojek Online Mobil", "Supir", "Agen Asuransi", "Cuci Mobil", "Aksesoris", "Sewa Mobil"],
  gadget: ["Konten Kreator", "Editing Photo/Video", "Freelance Fiverr", "Affiliate", "Dropshipper", "Servis HP", "Flashing HP", "Jual HP Bekas", "Reseller Aksesoris"],
  liburan: ["Content Creator", "Fotografer", "Tour Guide", "Cenderamatah", "Organizer", "Tiket Wisata", "Travel Planning", "Sewa Kamera", "Wedding Organizer", "Tour Leader"],
  haji: ["Jualan Oleh-oleh", "Katering Nasi Box", "Busana Muslim", "Agen Umroh", "Pembimbing Ibadah", "Pernak Pernikah", "Travel Umroh", "Kit Umroh", "Titip Jual", "Kain Tenun"],
  none: ["Freelance Umum", "Jualan Online", "Admin Sosmed", "Private Tutor", "Sewa Barang"]
};

// --- SIDE HUSTLE RECOMMENDATIONS ---
const sideHustleRecommendations = {
  lowSkill: [
    { name: "Ojek Online", earning: "Rp 100-200rb/hari", note: "Flexible waktu" },
    { name: "Jualan Pulsa/Data", earning: "Rp 500-800rb/bulan", note: "Modal kecil" },
    { name: "Admin Media Sosial", earning: "Rp 1-2jt/bulan", note: "Kerja remote" },
    { name: "Jasa Titip Belanja", earning: "Rp 300-500rb/bulan", note: "Dari rumah" },
    { name: "Jual Makanan Ringan", earning: "Rp 500rb-1jt/bulan", note: "Modal < Rp 500k" }
  ],
  mediumSkill: [
    { name: "Freelance Desain", earning: "Rp 2-5jt/project", note: "Butuh skill" },
    { name: "Tutor Privat", earning: "Rp 50-100rb/jam", note: "Mapel sekolah" },
    { name: "Jasa Service HP", earning: "Rp 500rb-2jt/bulan", note: "Butuh alat" },
    { name: "Konten Kreator", earning: "Rp 1-10jt/bulan", note: "Butuh konsisten" },
    { name: "Dropshipper", earning: "Rp 1-3jt/bulan", note: "Tanpa stok barang" }
  ]
};

// --- CREDIT SIMULATION DATABASE ---
const creditSimulations = {
  mobil: {
    defaultDP: 20,
    defaultInterest: 9, // 9% per tahun
    defaultTenor: 5, // 5 tahun
    description: "Rata-rata DP 20-30%, bunga 6-9%/tahun, tenor 1-7 tahun. Cicilan termasuk asuransi dan administrasi.",
    example: "Mobil Rp 200 juta, DP 20% (Rp 40 juta), pinjaman Rp 160 juta, bunga 9%/tahun, tenor 5 tahun = cicilan Â±Rp 3,3-3,8 juta/bulan."
  },
  motor: {
    defaultDP: 20,
    defaultInterest: 8, // 8% per tahun
    defaultTenor: 3, // 3 tahun
    description: "DP minimal 10-30%, bunga 6-9%/tahun atau 1-3%/bulan, tenor 1-3 tahun. Leasing motor umumnya lebih tinggi bunganya.",
    example: "Motor Rp 20 juta, DP 20% (Rp 4 juta), pinjaman Rp 16 juta, bunga 8%/tahun, tenor 3 tahun = cicilan Â±Rp 520-580 ribu/bulan."
  },
  rumah: {
    defaultDP: 20,
    defaultInterest: 8.5, // 8.5% per tahun
    defaultTenor: 15, // 15 tahun
    description: "KPR umumnya DP 10-30%, bunga fixed 2-5 tahun lalu floating, tenor 5-25 tahun. Biaya notaris, appraisal, administrasi.",
    example: "Rumah Rp 600 juta, DP 20% (Rp 120 juta), pinjaman Rp 480 juta, bunga 8.5%/tahun fixed 5 tahun, tenor 15 tahun = cicilan Â±Rp 5-6 juta/bulan tahun pertama."
  },
  gadget: {
    defaultDP: 0,
    defaultInterest: 3, // 3% per bulan (flat)
    defaultTenor: 1, // 1 tahun (12 bulan)
    description: "Sering 0% DP, bunga 0-6%/bulan flat, tenor 6-24 bulan. Biaya admin dan asuransi tambahan.",
    example: "HP Rp 18 juta, DP 0%, bunga 3%/bulan flat, tenor 12 bulan = cicilan Â±Rp 1,7-2 juta/bulan."
  },
  liburan: {
    defaultDP: 10,
    defaultInterest: 2.5, // 2.5% per bulan
    defaultTenor: 1, // 1 tahun
    description: "Paket tour bisa dicicil via travel agent atau KTA, DP 10-30%, bunga bervariasi, tenor 3-12 bulan.",
    example: "Liburan Jepang Rp 15 juta, DP 10% (Rp 1,5 juta), pinjaman Rp 13,5 juta, bunga 2.5%/bulan, tenor 12 bulan = cicilan Â±Rp 1,3-1,5 juta/bulan."
  },
  haji: {
    defaultDP: 30,
    defaultInterest: 7, // 7% per tahun (syariah)
    defaultTenor: 5, // 5 tahun
    description: "Pembiayaan syariah, DP 20-40%, margin/profit rate 7-12%/tahun, tenor 3-10 tahun.",
    example: "Paket Haji Rp 45 juta, DP 30% (Rp 13,5 juta), pembiayaan Rp 31,5 juta, margin 7%/tahun, tenor 5 tahun = cicilan Â±Rp 650-750 ribu/bulan."
  }
};

// --- CORE CALCULATION ---
async function hitung() {
  try {
    // VALIDASI DULU
    if (!validateInputs()) {
      return;
    }
    
    // Format all inputs before calculation
    const numericInputs = ['gajiPokok', 'sideHustle', 'debt', 'dreamPrice', 'currentSavings'];
    numericInputs.forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        formatInputValue(input);
      }
    });

    // Get values using improved parser
    const gajiPokok = parseFormattedNumber(document.getElementById('gajiPokok').value);
    const sideHustle = parseFormattedNumber(document.getElementById('sideHustle').value);
    const income = gajiPokok + sideHustle;
    const debtMonthly = parseFormattedNumber(document.getElementById('debt').value);
    const debtYearly = debtMonthly * 12; // Utang tahunan
    const currentSavings = parseFormattedNumber(document.getElementById('currentSavings').value);
    const dreamPrice = parseFormattedNumber(document.getElementById('dreamPrice').value);
    
    // Validate required field
    if(!gajiPokok || isNaN(gajiPokok) || gajiPokok <= 0) { 
      alert("Mohon isi Gaji Pokok Anda dengan benar (minimal 1)"); 
      return; 
    }

    // Loading state
    const btn = document.getElementById('btn-calc');
    const btnText = document.getElementById('btn-text');
    const originalText = btnText.innerText;
    btn.disabled = true; 
    btnText.innerText = "MENGHITUNG...";

    // --- FIXED FINANCIAL LOGIC ---
    const lifestyleFactor = { 'hemat': 0.8, 'standar': 1.0, 'mewah': 1.5 };
    const baseMult = { 'nikah':6, 'hamil':4, 'anak':3 };
    const statusVal = document.getElementById('status').value;
    const lifestyleVal = document.getElementById('lifestyle').value;
    const useInflation = document.getElementById('inflationToggle').checked;
    
    // Calculate target (kebutuhan untuk status tertentu)
    let target = Math.ceil(gajiPokok * baseMult[statusVal] * lifestyleFactor[lifestyleVal]);
    if(isNaN(target) || target <= 0) target = 0;

    let inflationHTML = "";
    
    if (useInflation) {
      const dateInput = document.getElementById('targetDate').value;
      if(dateInput) {
        const targetDate = new Date(dateInput);
        const today = new Date();
        
        // Calculate years difference
        const years = Math.max(0, Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24 * 365)));
        
        if(years > 0) {
          const inflatedTarget = Math.ceil(target * Math.pow(1.06, years));
          inflationHTML = `
            <div style="font-size:11px; color:var(--danger); background:var(--danger-bg); padding:4px 8px; border-radius:4px; display:inline-block; margin-bottom:4px;">
              <i class="fas fa-chart-line"></i> Dengan Inflasi: <strong>Rp ${formatIDR(inflatedTarget)}</strong>
            </div>`;
          target = inflatedTarget;
        }
      }
    }

    // --- FIXED PRIORITY LOGIC ---
    // 1. Dana Penyangga = 70% gaji Ã— 3 bulan
    const buffer = Math.ceil(gajiPokok * 0.7 * 3);
    
    // 2. Setelah Dana Penyangga, sisa untuk Dana Aman (Target - Buffer)
    const aman = Math.max(0, target - buffer);
    
    // 3. Kemampuan Menabung Bulanan
    const needsMonthly = Math.ceil(gajiPokok * 0.7); // Kebutuhan hidup 70% dari gaji
    const actualSave = gajiPokok - needsMonthly - debtMonthly; // Sisa setelah kebutuhan & utang
    
    // Update gold display with current price
    const goldGrams = (aman / goldPrice).toFixed(2);
    document.getElementById('emas').textContent = goldGrams + " gram";
    
    // Render chart with fixed dimensions
    renderChart(aman, buffer);

    // --- IMPROVED GAMIFICATION ---
    const gamificationWrapper = document.getElementById('gamification-wrapper');
    if(currentSavings > 0 && target > 0) {
      const percent = Math.min(100, Math.round((currentSavings / target) * 100));
      const gapPercent = 100 - percent;
      
      document.getElementById('prog-target').innerText = formatIDR(target);
      document.getElementById('prog-current').innerText = formatIDR(currentSavings);
      document.getElementById('prog-percent').innerText = percent + "%";
      document.getElementById('prog-gap').innerText = `Kurang ${gapPercent}% untuk mencapai target`;
      
      // Animate progress bar
      setTimeout(() => { 
        document.getElementById('prog-bar').style.width = percent + "%"; 
      }, 100);
      
      gamificationWrapper.style.display = 'block';
    } else {
      gamificationWrapper.style.display = 'none';
    }

    // --- MONTHLY ANALYSIS - FIXED LOGIC ---
    document.getElementById('cash-income').innerText = "Rp " + formatIDR(income);
    document.getElementById('cash-needs').innerText = formatIDR(needsMonthly) + ` (70%)`;
    document.getElementById('cash-debt').innerText = formatIDR(debtMonthly) + ` (${Math.round((debtMonthly/income)*100)}%)`;
    
    // FIXED: 16% tabungan adalah dari 30% sisa setelah 70% kebutuhan
    const savingsPercent = Math.round((actualSave / income) * 100);
    document.getElementById('cash-save').innerText = formatIDR(actualSave) + ` (${savingsPercent}%)`;

    // --- DETAILED CARDS ---
    document.getElementById('buffer-price').innerText = "Rp " + formatIDR(buffer);
    document.getElementById('target-price-detail').innerText = "Rp " + formatIDR(target);
    document.getElementById('inflation-alert').innerHTML = inflationHTML;
    
    const lifestyleText = lifestyleVal.charAt(0).toUpperCase() + lifestyleVal.slice(1);
    document.getElementById('lifestyle-tag-detail').innerText = lifestyleText;
    document.getElementById('lifestyle-text').innerText = lifestyleText;
    
    const reasonLists = {
      nikah: ["Biaya KUA & Legalitas", "Mahar/Seserahan", "Dekorasi & Catering", "Busana & MUA", "Gedung/Tenda", "Dokumentasi", "Souvenir", "Amplop", "Pindahan", "Dana Darurat"],
      hamil: ["Kontrol & USG", "Suplemen & Vitamin", "Biaya Persalinan RS", "Dokter Spesialis", "Stok Perlengkapan Bayi", "Stok Popok (NB-S)", "Stok Susu", "Biaya Perawatan Ibu", "Dana Darurat"],
      anak: ["Susu Formula", "Makanan Pendamping", "Pampers", "Imunisasi", "Dokter Anak", "Sekolah", "Transportasi", "Pakaian", "Mainan", "Dana Sakit"]
    };
    
    const listHTML = (reasonLists[statusVal] || []).map(item => `<li>${item}</li>`).join('');
    document.getElementById('budget-list-items').innerHTML = listHTML;

    // --- SAFE PRICE DETAILS ---
    document.getElementById('safe-price-detail').innerText = "Rp " + formatIDR(aman);

    // --- IMPROVED ACCOUNTING SUMMARY ---
    // 1. Total Aset Lancar (Current Assets) = Tabungan + Dana Penyangga 3 bulan
    const totalAsetLancar = currentSavings + buffer;
    
    // 2. Total Kewajiban (Liabilities) = Target + Utang tahunan
    const totalKewajiban = target + debtYearly;
    
    // 3. Ekuitas (Equity) = Aset - Kewajiban
    const ekuitas = totalAsetLancar - totalKewajiban;
    
    // 4. Rasio Keuangan (Financial Ratio) = Aset / Kewajiban
    const rasioKeuangan = totalKewajiban > 0 ? (totalAsetLancar / totalKewajiban).toFixed(2) : "âˆž";
    
    // 5. Analisis Rasio
    let rasioAnalysis = "";
    if (totalKewajiban === 0) {
      rasioAnalysis = "Tidak ada kewajiban - posisi sangat sehat";
    } else if (parseFloat(rasioKeuangan) >= 2) {
      rasioAnalysis = "Sangat sehat (aset 2x lipat kewajiban)";
    } else if (parseFloat(rasioKeuangan) >= 1) {
      rasioAnalysis = "Sehat (aset cukup untuk kewajiban)";
    } else if (parseFloat(rasioKeuangan) >= 0.5) {
      rasioAnalysis = "Perhatian (aset hanya setengah kewajiban)";
    } else {
      rasioAnalysis = "Bahaya (aset kurang dari setengah kewajiban)";
    }
    
    // Update accounting summary dengan detail
    document.getElementById('total-aset').innerHTML = `
      Rp ${formatIDR(totalAsetLancar)}
      <div style="font-size:9px; color:#cbd5e1; text-align:right; padding:0 0 4px 0; font-weight:normal;">
        (Tabungan Rp ${formatIDR(currentSavings)} + Dana Darurat Rp ${formatIDR(buffer)})
      </div>
    `;
    
    document.getElementById('total-kewajiban').innerHTML = `
      Rp ${formatIDR(totalKewajiban)}
      <div style="font-size:9px; color:#cbd5e1; text-align:right; padding:0 0 4px 0; font-weight:normal;">
        (Target: Rp ${formatIDR(target)} + Utang/tahun: Rp ${formatIDR(debtYearly)})
      </div>
    `;
    
    document.getElementById('ekuitas').innerHTML = `
      <span style="color:${ekuitas >= 0 ? '#34d399' : '#fca5a5'}">
        Rp ${formatIDR(ekuitas)}
      </span>
      <div style="font-size:9px; color:#cbd5e1; text-align:right; padding:0 0 4px 0; font-weight:normal;">
        (Rp ${formatIDR(totalAsetLancar)} - Rp ${formatIDR(totalKewajiban)})
      </div>
    `;
    
    document.getElementById('rasio-keuangan').textContent = rasioKeuangan;
    document.getElementById('rasio-explanation').textContent = rasioAnalysis;

    // --- ANALOGI PERJALANAN - BAHASA SEHARI-HARI ---
    const analogyContent = document.getElementById('analogy-content');
    let analogyHTML = "";
    
    if (rasioKeuangan !== "âˆž") {
      const rasioNum = parseFloat(rasioKeuangan);
      
      analogyHTML = `
        <div class="analogy-point">
          <strong>Keuanganmu seperti:</strong> 
          ${rasioNum >= 1 ? 
            "Orang yang punya tabungan lebih banyak dari utang. Bisa tenang." : 
            rasioNum >= 0.5 ? 
            "Orang yang tabungannya setengah dari utang. Perlu waspada." : 
            "Orang yang utangnya lebih besar 2x dari tabungan. Harus segera berbenah."}
        </div>
        <div class="analogy-point">
          <strong>Gajimu Rp ${formatIDR(gajiPokok)}:</strong> 
          ${actualSave > 0 ? 
            `Cukup untuk hidup 30 hari, masih bisa nabung Rp ${formatIDR(actualSave)}/bulan.` : 
            'Habis untuk kebutuhan saja, tidak ada sisa.'}
        </div>
        <div class="analogy-point">
          <strong>Target Dana Besar Rp ${formatIDR(target)}:</strong> 
          ${currentSavings >= target ? 
            'SUDAH TERCAPAI! ðŸŽ‰' : 
            `Butuh Rp ${formatIDR(target - currentSavings)} lagi.`}
        </div>
        <div class="analogy-point">
          <strong>Saran Praktis:</strong> 
          ${actualSave > 0 ? 
            `Sisihkan Rp ${formatIDR(Math.floor(actualSave/2))} untuk lunasi utang, Rp ${formatIDR(Math.ceil(actualSave/2))} untuk tambah tabungan.` : 
            'Cari cara kurangi pengeluaran atau tambah penghasilan.'}
        </div>
      `;
    }
    
    analogyContent.innerHTML = analogyHTML;

    // --- IMPROVED SOLUTIONS ---
    const solutionWrapper = document.getElementById('solution-wrapper');
    const solutionList = document.getElementById('solution-list-content');
    
    let solutions = [];
    let solutionNumber = 1;
    
    // Analysis based on accounting ratios
    let analysisText = `Berdasarkan analisis akuntansi, rasio keuangan Anda adalah <strong>${rasioKeuangan}</strong> (aset vs kewajiban).`;
    
    // Recommendations based on financial ratios
    if (parseFloat(rasioKeuangan) >= 2 || totalKewajiban === 0) {
      solutions.push(`<span class="solution-icon"><i class="fas fa-check-circle"></i></span> <span class="solution-number">${solutionNumber}.</span> <strong>Posisi Sangat Kuat:</strong> Aset Anda lebih dari 2x kewajiban. Pertimbangkan investasi.`);
      solutionNumber++;
    } else if (parseFloat(rasioKeuangan) >= 1) {
      solutions.push(`<span class="solution-icon"><i class="fas fa-check-circle"></i></span> <span class="solution-number">${solutionNumber}.</span> <strong>Posisi Sehat:</strong> Aset cukup untuk menutup kewajiban. Fokus pada peningkatan tabungan.`);
      solutionNumber++;
    } else {
      const deficit = totalKewajiban - totalAsetLancar;
      const monthlyDeficit = Math.ceil(deficit / 12); // Defisit per bulan selama 1 tahun
      solutions.push(`<span class="solution-icon"><i class="fas fa-exclamation-triangle"></i></span> <span class="solution-number">${solutionNumber}.</span> <strong>Perlu Perhatian:</strong> Kurang <strong>Rp ${formatIDR(deficit)}</strong> untuk menutup kewajiban.`);
      solutionNumber++;
    }
    
    // Debt advice
    if (debtMonthly > 0) {
      const debtToIncomeRatio = (debtMonthly / gajiPokok) * 100;
      if (debtToIncomeRatio > 30) {
        solutions.push(`<span class="solution-icon"><i class="fas fa-exclamation-circle"></i></span> <span class="solution-number">${solutionNumber}.</span> <strong>Utang Tinggi:</strong> Cicilan ${Math.round(debtToIncomeRatio)}% dari gaji. Prioritaskan pelunasan.`);
      } else {
        solutions.push(`<span class="solution-icon"><i class="fas fa-check-circle"></i></span> <span class="solution-number">${solutionNumber}.</span> <strong>Utang Terkendali:</strong> Cicilan ${Math.round(debtToIncomeRatio)}% dari gaji.`);
      }
      solutionNumber++;
    }
    
    // Savings rate advice
    const savingsRate = (actualSave / gajiPokok) * 100;
    if (savingsRate < 10) {
      solutions.push(`<span class="solution-icon"><i class="fas fa-exclamation-triangle"></i></span> <span class="solution-number">${solutionNumber}.</span> <strong>Tabungan Rendah:</strong> Hanya ${Math.round(savingsRate)}% dari gaji. Targetkan minimal 20%.`);
      solutionNumber++;
    }
    
    // Dream-specific advice
    const dreamType = document.getElementById('dreamType').value;
    if (statusVal === 'nikah' && dreamType === 'none') {
      solutions.push(`<span class="solution-icon"><i class="fas fa-gem"></i></span> <span class="solution-number">${solutionNumber}.</span> <strong>Fokus Target:</strong> Arahkan dana ke Mahar/Emas sebagai investasi.`);
      solutionNumber++;
    }
    
    solutionList.innerHTML = `
      <li style="margin-bottom: 12px; font-size: 13px; color: var(--text-muted);">${analysisText}</li>
      ${solutions.map(s => `<li>${s}</li>`).join('')}
    `;

    // --- 5 PILIHAN SIDE HUSTLE ---
    const sideHustleContainer = document.getElementById('side-hustle-recommendations');
    
    // PILIH BERDASARKAN INCOME
    const hustles = income <= 5000000 ? sideHustleRecommendations.lowSkill : sideHustleRecommendations.mediumSkill;
    
    const hustleHTML = `
      <div style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 12px;">
        <div style="font-weight: 700; color: var(--primary-dark); margin-bottom: 8px;">
          <i class="fas fa-briefcase"></i> 5 Ide Tambah Penghasilan:
        </div>
        <div style="display: grid; gap: 8px;">
          ${hustles.slice(0, 5).map((h, i) => `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 8px; background: #f8fafc; border-radius: 6px; border-left: 3px solid var(--primary);">
              <div>
                <strong>${i+1}. ${h.name}</strong>
                <div style="font-size: 11px; color: var(--text-muted);">${h.note}</div>
              </div>
              <div style="font-size: 12px; font-weight: 700; color: var(--success);">
                ${h.earning}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    
    sideHustleContainer.innerHTML = hustleHTML;

    // --- STRATEGY WITH ICONS ---
    const strategyWrapper = document.getElementById('strategy-wrapper');
    
    let strategyTitle = ""; 
    let strategyContent = ""; 
    let strategyColor = "";
    let strategyIcon = "";
    
    if (savingsRate < 10) {
      strategyTitle = "ðŸŒ± Level Pemula"; 
      strategyIcon = "<i class='fas fa-seedling'></i>";
      strategyContent = "Mulailah dari Rp 50.000 saja dulu. Fokus pada konsistensi."; 
      strategyColor = "var(--info-bg)";
    } else if (savingsRate >= 30) {
      strategyTitle = "ðŸš€ Level Sultan"; 
      strategyIcon = "<i class='fas fa-rocket'></i>";
      strategyContent = "Luar biasa! Anda sudah menerapkan prinsip keuangan yang sehat."; 
      strategyColor = "var(--success-bg)";
    } else {
      strategyTitle = "ðŸ“ˆ Level Aman"; 
      strategyIcon = "<i class='fas fa-chart-line'></i>";
      strategyContent = "Coba tingkatkan tabungan 5% lagi untuk mempercepat target."; 
      strategyColor = "#fffbeb";
    }

    strategyWrapper.innerHTML = `
      <div class="info-box" style="background:${strategyColor}; border-color:transparent; margin-top:16px;">
        <div class="info-header">
          <div class="info-title">
            ${strategyIcon}
            Strategi Keuanganmu
          </div>
          <div style="font-size:12px; font-weight:800; color:#64748b;">${Math.round(savingsRate)}% Tabungan/bulan</div>
        </div>
        <div style="font-size:18px; font-weight:800; margin:4px 0;">${strategyTitle}</div>
        <div class="info-desc" style="font-size:13px; line-height:1.5;">${strategyContent}</div>
      </div>
    `;

    // --- IMPROVED DREAM PLANNER WITH REAL CREDIT SIMULATION ---
    const dreamWrapper = document.getElementById('dream-result-wrapper');
    const dreamMethod = document.getElementById('dreamMethod').value;
    const dpInput = document.getElementById('dpPercent').value;
    const tenorInput = document.getElementById('tenorYears').value;
    const rateInput = document.getElementById('interestRate').value;
    let dreamHTML = "";
    
    if(dreamType !== 'none' && dreamPrice > 0) {
      // Get credit simulation data for this dream type
      const creditData = creditSimulations[dreamType] || {
        defaultDP: 20,
        defaultInterest: 12,
        defaultTenor: 3,
        description: "Simulasi kredit umum dengan DP 20%, bunga 12%/tahun.",
        example: "Contoh simulasi standar."
      };
      
      let dpPercent = parseInt(dpInput) || creditData.defaultDP; 
      let isCreditRisky = false;
      let kreditHTML = "";
      let creditInfo = "";

      if(dreamMethod === 'kredit') {
        // Apply specific credit parameters based on dream type
        const defaultRate = parseInt(rateInput) || creditData.defaultInterest;
        const defaultTenor = parseInt(tenorInput) || creditData.defaultTenor;
        
        const dpAmount = dreamPrice * (dpPercent / 100);
        const principal = dreamPrice - dpAmount; // Pokok pinjaman
        const rate = defaultRate / 100;
        const years = defaultTenor;
        const months = years * 12;
        
        // Hitung bunga flat
        const totalInterest = principal * rate * years;
        const totalPay = principal + totalInterest;
        const monthlyInstallment = Math.ceil(totalPay / months);
        
        // Persentase kenaikan karena kredit
        const percentIncrease = Math.round(((totalPay - dreamPrice) / dreamPrice) * 100);

        const maxInstallment = gajiPokok * 0.3;
        isCreditRisky = monthlyInstallment > maxInstallment;
        
        // Credit info specific to dream type
        creditInfo = `
          <div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 11px;">
            <div style="font-weight: 600; color: #94a3b8; margin-bottom: 2px;">ðŸ“Š Info Kredit ${dreamType.toUpperCase()}:</div>
            <div style="color: #cbd5e1; font-size: 10px; line-height: 1.3;">${creditData.description}</div>
          </div>
        `;

        kreditHTML = `
          ${creditInfo}
          <div style="background:var(--bg-body); padding:12px; border-radius:8px; margin-top:12px; border:1px solid var(--border);">
            <div style="font-size:11px; font-weight:700; color:var(--text-muted); margin-bottom:6px;">
              <i class="fas fa-file-invoice-dollar"></i> RINCIAN KREDIT
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-bottom:4px; padding:4px 0;">
              <span style="color:var(--text-muted);">Uang Muka (DP):</span>
              <span style="font-weight:600;">Rp ${formatIDR(dpAmount)} (${dpPercent}%)</span>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-bottom:4px; padding:4px 0; border-top:1px dashed #e2e8f0; padding-top:6px;">
              <span style="color:var(--text-muted);">Pokok Pinjaman:</span>
              <span>Rp ${formatIDR(principal)}</span>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-bottom:4px; padding:4px 0;">
              <span style="color:var(--text-muted);">Total Bunga (${defaultRate}%/tahun):</span>
              <span style="color:var(--danger); font-weight:600;">Rp ${formatIDR(totalInterest)}</span>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-bottom:4px; padding:4px 0;">
              <span style="color:var(--text-muted);">Total Bayar:</span>
              <span style="font-weight:700;">Rp ${formatIDR(totalPay)}</span>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-top:8px; padding:6px 0; border-top:1px dashed #e2e8f0;">
              <span style="color:var(--text-muted);">Cicilan/bulan (${years} tahun):</span>
              <span style="font-size:14px; font-weight:800; color:var(--text-main);">Rp ${formatIDR(monthlyInstallment)}</span>
            </div>
            
            <div style="margin-top:8px; padding:8px; background:${percentIncrease > 20 ? 'var(--danger-bg)' : 'var(--info-bg)'}; border-radius:4px; font-size:11px;">
              <i class="fas fa-chart-line"></i> <strong>Kenaikan ${percentIncrease}%</strong> dari harga tunai karena bunga kredit.
            </div>
            
            <div style="margin-top:6px; font-size:10px; color:var(--text-muted); font-style:italic;">
              <i class="fas fa-info-circle"></i> ${creditData.example}
            </div>
          </div>
          
          <div style="margin-top:10px; padding:8px; border-radius:6px; font-size:12px; background:${isCreditRisky ? 'var(--danger-bg)' : 'var(--success-bg)'}; border-left:4px solid ${isCreditRisky ? 'var(--danger)' : 'var(--success)'};">
            ${isCreditRisky ? 
              `âš ï¸ <strong>PERHATIAN:</strong> Cicilan melebihi 30% gaji (${Math.round((monthlyInstallment/gajiPokok)*100)}%).` : 
              `âœ… <strong>AMAN:</strong> Cicilan ${Math.round((monthlyInstallment/gajiPokok)*100)}% dari gaji.`
            }
          </div>
        `;
      }

      // LOGIKA BARU: Dana DP hanya boleh diambil dari Dana Aman (setelah Dana Penyangga)
      let dpNeeded = (dreamMethod === 'tunai') ? dreamPrice : dpAmount;
      
      // Cek apakah Dana Aman cukup untuk DP
      let status = aman >= dpNeeded; 
      let label = status ? 'CUKUP AMAN' : 'BELUM CUKUP';
      let msg = "";
      let analogyMsg = "";
      
      if(!status) {
        const deficit = dpNeeded - aman;
        let itemText = dreamMethod === 'tunai' ? "Pelunasan Tunai" : "Uang Muka (DP)";
        
        // Hitung berapa bulan menabung dari sisa tabungan bulanan
        const monthsToSave = Math.ceil(deficit / actualSave);
        
        msg = `Kurang <strong>Rp ${formatIDR(deficit)}</strong> untuk ${itemText} ${dreamType.toUpperCase()}.`;
        analogyMsg = `Butuh <strong>${monthsToSave} bulan</strong> menabung dari sisa penghasilan (Rp ${formatIDR(actualSave)}/bln).`;
      } else {
        msg = `Dana Aman cukup untuk ${dreamMethod === 'tunai' ? 'pelunasan' : 'DP'}.`;
        
        // Hitung berapa persen dari Dana Aman yang digunakan
        const percentUsed = Math.round((dpNeeded / aman) * 100);
        analogyMsg = `Menggunakan <strong>${percentUsed}%</strong> dari Dana Aman Anda.`;
      }

      dreamHTML = `
        <div class="dream-result-card">
          <div class="info-header">
            <div class="info-title">
              <i class="fas fa-bullseye"></i>
              Cek Mimpi: ${dreamType.toUpperCase()}
            </div>
            <span class="info-tag">${dreamMethod.toUpperCase()} ${dreamMethod==='kredit'?`(${dpPercent}% DP)`:''}</span>
          </div>
          
          <div style="margin-bottom: 12px;">
            <div style="font-size:13px; color:var(--text-muted);">Harga Tunai</div>
            <div style="font-size:22px; font-weight:800; color:var(--text-main);">Rp ${formatIDR(dreamPrice)}</div>
          </div>
          
          <div style="margin-bottom: 12px;">
            <div style="font-size:13px; color:var(--text-muted);">Dana Tunai Dibutuhkan</div>
            <div style="font-size:16px; font-weight:700; color:var(--text-main);">Rp ${formatIDR(dpNeeded)}</div>
            <div style="font-size:11px; color:var(--text-muted); margin-top:2px;">
              ${dreamMethod==='kredit'?'(DP dari Dana Aman)':'(Dana Aman dari sisa setelah Dana Penyangga)'}
            </div>
          </div>
          
          ${kreditHTML}

          <div class="dream-status-badge ${status?'status-success':'status-fail'}">
            ${status ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-triangle"></i>'}
            ${label}
          </div>
          
          <div style="margin-top:12px; padding:10px; background:${status ? 'var(--success-bg)' : 'var(--info-bg)'}; border-radius:6px;">
            <div style="font-size:13px; color:${status ? 'var(--success-dark)' : 'var(--text-main)'}; margin-bottom:4px;">
              <i class="fas fa-info-circle"></i> ${msg}
            </div>
            <div style="font-size:11px; color:${status ? 'var(--success)' : 'var(--text-muted)'};">
              <i class="fas fa-calculator"></i> ${analogyMsg}
            </div>
          </div>
        </div>`;
    }
    dreamWrapper.innerHTML = dreamHTML;

    // --- IMPROVED ADVICE ---
    const adviceWrapper = document.getElementById('advice-wrapper');
    const tips = adviceDB[statusVal] || [
      "Prioritaskan kebutuhan dasar.",
      "Hindari utang konsumtif.",
      "Sisihkan minimal 10% untuk tabungan.",
      "Evaluasi pengeluaran bulanan.",
      "Buat rencana keuangan jangka pendek."
    ];
    
    // Ambil 5 tips unik
    const shuffledTips = [...new Set(tips)].sort(() => 0.5 - Math.random()).slice(0, 5);
    
    adviceWrapper.innerHTML = `
      <div class="advice-title">
        <i class="fas fa-graduation-cap"></i>
        Nasehat Harianmu
      </div>
      <ul class="advice-list">
        ${shuffledTips.map(t => `<li><i class="fas fa-check"></i> ${t}</li>`).join('')}
      </ul>
    `;

    // Update gold price display
    updateGoldPriceInUI();

    // --- TARGET PLAN ---
    const dateInput = document.getElementById('targetDate').value;
    const planCard = document.getElementById('target-plan-card');
    
    if(dateInput) {
      planCard.style.display = 'block';
      const targetDate = new Date(dateInput);
      const today = new Date();
      
      // Calculate months difference
      const diffMonths = Math.max(0, Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24 * 30)));
      const perMonth = diffMonths > 0 ? Math.ceil(aman / diffMonths) : 0;
      const daily = Math.ceil(perMonth / 30);
      const weekly = Math.ceil(perMonth / 4);
      
      let contextText = "";
      if (daily < 10000) contextText = "Setara dengan tidak jajan 1 hari.";
      else if (daily < 25000) contextText = "Setara dengan mengurangi rokok 1 bungkus.";
      else if (daily < 50000) contextText = "Setara dengan bawa bekal daripada beli makan.";
      else if (daily < 100000) contextText = "Setara dengan mengurangi transportasi 2-3 hari.";
      else contextText = "Setara dengan mengurangi makan di luar 1-2 kali.";

      document.getElementById('plan-date').innerText = targetDate.toLocaleDateString('id-ID');
      document.getElementById('plan-months').innerText = diffMonths + " Bulan";
      document.getElementById('plan-daily').innerText = "Rp " + formatIDR(daily);
      document.getElementById('plan-weekly').innerText = "Rp " + formatIDR(weekly);
      document.getElementById('plan-context').innerText = contextText;
      document.getElementById('plan-monthly').innerText = "Rp " + formatIDR(perMonth) + " / bln";
      
      const compBox = document.getElementById('plan-comparison-box');
      if (perMonth <= actualSave) {
          const surplus = actualSave - perMonth;
          compBox.innerHTML = `<div style="color:var(--success-dark); font-weight:700;"><i class="fas fa-check-circle"></i> TARGET TERJANGKAU (Sisa: Rp ${formatIDR(surplus)}/bln)</div>`;
          compBox.style.background = "var(--success-bg)"; 
          compBox.style.border = "1px solid #a7f3d0";
      } else {
          const deficit = perMonth - actualSave;
          compBox.innerHTML = `<div style="color:var(--danger); font-weight:700;"><i class="fas fa-exclamation-triangle"></i> PERLU EKSTRA (Kurang: Rp ${formatIDR(deficit)}/bln)</div>`;
          compBox.style.background = "var(--danger-bg)"; 
          compBox.style.border = "1px solid #fecaca";
      }
    } else {
      planCard.style.display = 'none';
    }

    // --- TRANSITION UI ---
    document.getElementById('input-section').classList.add('hidden');
    document.getElementById('unlock-btn').classList.remove('hidden');
    document.getElementById('btn-calc').classList.add('hidden');
    document.getElementById('initial-msg').classList.add('hidden');
    document.getElementById('detail-container').classList.remove('hidden');
    document.getElementById('back-btn').classList.remove('hidden'); // Show back button
    
    // Restore button
    btn.disabled = false; 
    btnText.innerText = originalText;
    
    // Scroll to results on mobile
    if(window.innerWidth < 768) {
      setTimeout(() => {
        document.getElementById('result-section').scrollIntoView({behavior:'smooth', block: 'start'});
      }, 300);
    }

  } catch(err) {
    console.error("Critical Error:", err);
    alert("Terjadi kesalahan sistem. Silakan coba lagi atau refresh halaman.");
    
    const btn = document.getElementById('btn-calc');
    const btnText = document.getElementById('btn-text');
    btn.disabled = false; 
    btnText.innerText = "ANALISIS KEAMANAN SAYA";
  }
}
</script>
</body>
</html>
