<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;

/* ================================
   KONFIGURASI TERKUNCI
================================ */
const HARGA_EMAS = 2652000; // Rp / gram (Antam Logam Mulia)

/* ================================
   FORMAT
================================ */
function formatIDR(x){
  return x.toLocaleString("id-ID");
}

/* ================================
   HITUNG UTAMA
================================ */
function hitung(){
  const incomeRaw = document.getElementById("income").value.replace(/\./g,"");
  const income = Number(incomeRaw);
  const status = document.getElementById("status").value;

  if(!income || income <= 0){
    document.getElementById("emas").innerText = "–";
    document.getElementById("detail").innerHTML = "";
    return;
  }

  const mult = { nikah:6, hamil:4, anak:3 };
  const statusText = { nikah:"Akan Menikah", hamil:"Hamil", anak:"Punya Anak" };

  const risiko = income * mult[status];
  const buffer = income * 0.7 * 3;
  let aman = risiko - buffer;
  if(aman < 0) aman = 0;

  const gram = Math.floor(aman / HARGA_EMAS);
  const cicil6 = Math.ceil(aman / 6);
  const cicil12 = Math.ceil(aman / 12);

  document.getElementById("emas").innerText = gram + " gram emas";

  document.getElementById("detail").innerHTML = `
    <b>Status:</b> ${statusText[status]}<br>
    <b>Risiko biaya:</b> Rp ${formatIDR(risiko)}<br>
    <b>Dana penyangga hidup (90 hari):</b> Rp ${formatIDR(buffer)}<br><br>

    <b>Uang yang boleh dikunci:</b> Rp ${formatIDR(aman)}<br>
    <b>Setara emas:</b> ${gram} gram<br>
    <b>Harga emas Antam:</b> Rp ${formatIDR(HARGA_EMAS)} / gram<br><br>

    <b>Skema cicilan:</b><br>
    • 6 bulan: Rp ${formatIDR(cicil6)} / bulan<br>
    • 12 bulan: Rp ${formatIDR(cicil12)} / bulan
  `;

  /* ===== Chart ===== */
  const amanVal = aman;
  const risikoVal = risiko - aman;

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"),{
    type:"doughnut",
    data:{
      labels:["Aman (boleh dikunci)","Berisiko (harus cair)"],
      datasets:[{
        data:[amanVal, risikoVal],
        backgroundColor:["#36a2eb","#ff6384"]
      }]
    },
    options:{
      animation:{ duration:600 }
    }
  });

  /* ===== WhatsApp CTA ===== */
  const waText = encodeURIComponent(
`Saya mau amankan dana ${statusText[status]}.

Penghasilan: Rp ${formatIDR(income)}
Dana aman: Rp ${formatIDR(aman)}
Setara: ${gram} gram emas

Mohon bantu skema cicilannya.`
  );

  const waBtn = document.getElementById("waBtn");
  waBtn.style.display = "block";
  waBtn.onclick = () => {
    window.open("https://wa.me/6285123882845?text="+waText,"_blank");
  };
}

/* ================================
   INPUT FORMAT RIBUAN
================================ */
document.getElementById("income").addEventListener("input", function(e){
  let v = e.target.value.replace(/\D/g,"");
  e.target.value = v.replace(/\B(?=(\d{3})+(?!\d))/g,".");
  hitung();
});

document.getElementById("status").addEventListener("change", hitung);
</script>
