<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalkulator Keamanan ‚Äì HONORER DIGITAL</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* ===== VARS ===== */
:root {
  --primary: #fbbf24;
  --primary-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
  --success: #10b981;
  --success-dark: #065f46;
  --danger: #ef4444;
  --warning: #f59e0b;
  --info: #3b82f6;
  
  --bg-body: #f0fdf4;
  --bg-card: #ffffff;
  --text-main: #1f2937;
  --text-muted: #64748b;
  --border: #d1fae5;
  
  --radius: 24px;
  --radius-sm: 14px;
  --shadow-card: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
  --shadow-button: 0 10px 20px -5px rgba(245, 158, 11, 0.4);
}

*{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body{
  font-family: 'Plus Jakarta Sans', sans-serif;
  background-color: var(--bg-body);
  background-image: radial-gradient(#a7f3d0 1px, transparent 1px), radial-gradient(#a7f3d0 1px, transparent 1px);
  background-size: 20px 20px;
  background-position: 0 0, 10px 10px;
  margin:0; padding:40px 20px; color:var(--text-main); min-height: 100vh;
}

/* HEADER */
.header-wrapper { text-align: center; margin-bottom: 40px; animation: fadeIn 0.8s ease-out; }
.header-wrapper h1 {
  font-size: 36px; font-weight: 800; color: var(--success-dark); margin: 0; text-transform: uppercase; letter-spacing: -1px; text-shadow: 2px 2px 0px rgba(16, 185, 129, 0.1);
}
.header-wrapper span { color: var(--primary); }

/* LAYOUT */
.app{ max-width:1100px; margin:0 auto; display:grid; grid-template-columns:1fr 1.2fr; gap:40px; }

/* CARDS */
.card{
  background: var(--bg-card); padding: 35px; border-radius: var(--radius);
  box-shadow: var(--shadow-card); border: 1px solid #ffffff; position: relative; overflow: hidden;
}
.card { animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(30px); }
.card:nth-child(2) { animation-delay: 0.15s; }

/* TYPOGRAPHY */
h2 { margin-top:0; margin-bottom:25px; font-size: 18px; color: var(--text-main); font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
label { font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
input, select {
  width:100%; padding: 14px 16px; font-size: 14px; font-family: 'Plus Jakarta Sans', sans-serif;
  color: var(--text-main); background: #f8fafc; border: 2px solid #e2e8f0; border-radius: var(--radius-sm);
  transition: all 0.3s ease; outline: none; font-weight: 600;
}
input:focus, select:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.15); transform: scale(1.01); }

/* BUTTONS */
button {
  width: 100%; padding: 18px; margin-top: 30px; font-size: 16px; font-weight: 800; border-radius: var(--radius-sm);
  border: none; cursor: pointer; font-family: 'Plus Jakarta Sans', sans-serif; letter-spacing: 0.5px; transition: all 0.2s ease;
}
#btn-calc { background: var(--primary-gradient); color: white; box-shadow: var(--shadow-button); text-transform: uppercase; }
#btn-calc:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(245, 158, 11, 0.5); }
#btn-calc:disabled { background: #cbd5e1; color: #fff; cursor: not-allowed; transform: none; box-shadow: none; }
#unlock-btn { display: none; margin-top: 20px; font-size: 14px; font-weight: 700; color: var(--text-muted); background: #f1f5f9; padding: 12px; border-radius: 12px; width: 100%; border: none; cursor: pointer; text-align: center; transition:0.2s; }
#unlock-btn:hover { background: #e2e8f0; color: var(--text-main); }

.spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; display: none; margin-right: 10px; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }

/* CTA GROUPS */
.cta-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
.cta { background: #1e293b; color: #fff; padding: 12px; margin-top: 0; font-size: 13px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border:none; cursor:pointer; transition:0.2s; }
.cta:hover { background: black; transform: translateY(-2px); }
.cta.donate { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.cta.help { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }

/* RESULT WRAPPER */
.result-wrapper { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px dashed #e2e8f0; animation: fadeIn 1s ease-out; }
.big-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); font-weight: 800; margin-bottom: 12px; }
.big-value { font-size: 40px; font-weight: 900; color: var(--success-dark); margin: 0; line-height: 1; background: -webkit-linear-gradient(#064e3b, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.sub-value { font-size: 13px; color: var(--text-muted); margin-top: 8px; font-weight: 600; }

#chart-container { position: relative; height: 200px; width: 100%; margin-bottom: 20px; animation: fadeIn 1.2s ease-out; }
#detail { font-size: 14px; line-height: 1.5; color: var(--text-main); display:none; }

/* SECTIONS & BOXES */
.section-box {
  background: #f8fafc; padding: 16px; border-radius: 16px; margin-bottom: 16px; border: 1px solid var(--border);
  opacity: 0; animation: slideUpFade 0.6s ease forwards;
}
.section-box.danger-box { background: #fef2f2; border-color: #fee2e2; }
.section-box.warning-box { background: #fffbeb; border-color: #fcd34d; }
.section-box.dream-box { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 20px; border: 1px solid #e2e8f0; }

.section-title { font-weight: 800; font-size: 15px; margin-bottom: 8px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
.section-tag { font-size: 9px; padding: 4px 10px; border-radius: 50px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
.tag-yellow { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
.tag-green { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
.tag-blue { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
.tag-red { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }

.section-price { font-size: 22px; font-weight: 800; color: var(--text-main); margin: 8px 0 12px 0; letter-spacing: -1px; }
.section-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 0; line-height: 1.5; }
.section-box.dream-box .section-desc { color: #e2e8f0; }
.section-box.dream-box .section-title { color: white; }
.section-box.dream-box input { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white; }
.section-box.dream-box select { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white; }
.section-box.dream-box label { color: #94a3b8; }

.progress-bar-container { margin-top: 10px; background: #e2e8f0; border-radius: 8px; height: 10px; overflow: hidden; display: flex; }
.progress-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 700; color: rgba(0,0,0,0.5); }
.seg-hidup { background: #3b82f6; }
.seg-utang { background: #ef4444; }
.seg-sisa { background: #10b981; }

/* ACTION PLAN BOX */
.action-plan-box {
  background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
  border: 1px solid #fed7aa;
  padding: 12px; border-radius: 10px; margin-top: 10px;
}
.action-header { font-size: 11px; font-weight: 800; color: #c2410c; text-transform: uppercase; margin-bottom: 8px; display: block; }
.action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
.action-item { background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px; text-align: center; }
.action-label { font-size: 10px; color: #9a3412; font-weight: 600; display: block; margin-bottom: 2px; }
.action-val { font-size: 14px; font-weight: 800; color: #9a3412; display: block; }
.action-tip { font-size: 11px; color: #7c2d12; line-height: 1.3; font-style: italic; background: rgba(255,255,255,0.5); padding: 6px; border-radius: 4px; }

.advice-box {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;
  padding: 16px; border-radius: 16px; margin-bottom: 20px; font-size: 13px; line-height: 1.5;
  box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
}

.plan-box { background: #ffffff; border-radius: 12px; padding: 16px; margin-top: 16px; border: 2px solid #e2e8f0; }
.plan-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; color: #475569; font-weight: 500; }
.plan-row.highlight { font-size: 16px; font-weight: 800; color: var(--success-dark); border-top: 2px dashed #cbd5e1; padding-top: 10px; margin-top: 10px; margin-bottom: 0; }

.footnote { font-size: 11px; color: #64748b; margin-top: 10px; line-height: 1.3; font-style: italic; background: #f1f5f9; padding: 8px; border-radius: 6px; }

.api-status { font-size: 10px; padding: 4px 10px; border-radius: 50px; background: #f1f5f9; color: #64748b; font-weight: 800; text-transform: uppercase; border: 1px solid #e2e8f0; transition: all 0.3s; }
.api-status.status-online { background: #d1fae5; color: #059669; border-color: #10b981; animation: pulse-green 2s infinite; }
@keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

/* DREAM GRID */
.dream-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
.dream-feasibility { text-align: center; font-size: 20px; font-weight: 800; color: #fbbf24; margin: 10px 0 5px 0; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; }

/* PROBLEM SOLVER */
.help-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 10px; }
.help-btn-sm { background: rgba(255,255,255,0.1); border: 1px solid #bfdbfe; padding: 8px; border-radius: 6px; text-align: center; font-size: 10px; font-weight: 700; color: #60a5fa; cursor: pointer; transition: 0.2s; }
.help-btn-sm:hover { background: #fff; transform: translateY(-2px); }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUpFade { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

/* RESPONSIVE */
@media(max-width:768px){
  .app{grid-template-columns:1fr;}
  .header-wrapper h1{ font-size: 28px; }
  .big-value { font-size: 34px; }
  .card { padding: 30px 24px; }
  .section-price { font-size: 20px; }
  .cta-group { grid-template-columns: 1fr; }
  .dream-grid { grid-template-columns: 1fr; }
}
</style>
</head>

<body>

<div class="header-wrapper">
  <h1>HONORER <span>DIGITAL</span></h1>
</div>

<div class="app">

<!-- LEFT CARD: INPUT -->
<div class="card" id="input-section">
<h2>
  <span>Rencana Keuangan</span>
  <span class="api-status" id="apiStatus">Checking...</span>
</h2>

<!-- INPUT SUMBER DANA -->
<div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
  <div>
    <label>Gaji Pokok</label>
    <input id="gajiPokok" type="text" placeholder="Contoh: 3.000.000" autocomplete="off">
  </div>
  <div>
    <label>Side Hustle (Bonus)</label>
    <input id="sideHustle" type="text" placeholder="Contoh: 1.000.000" autocomplete="off">
  </div>
</div>

<label>Status saat ini</label>
<select id="status">
  <option value="nikah">Akan Menikah</option>
  <option value="hamil">Hamil / Persalinan</option>
  <option value="anak">Sudah Punya Anak (Sudah Nikah)</option>
</select>

<div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
  <div>
    <label>Gaya Hidup</label>
    <select id="lifestyle">
      <option value="hemat">Hemat (Frugal)</option>
      <option value="standar" selected>Standar</option>
      <option value="mewah">Mewah</option>
    </select>
  </div>
  <div>
    <label>Cicilan Utang/Bln</label>
    <input id="debt" type="text" placeholder="0" autocomplete="off">
  </div>
</div>

<!-- DREAM PLANNER INPUT (FITUR BARU) -->
<div class="section-box dream-box" style="opacity:1; animation:none;">
  <div class="section-title" style="color:white;">
    <span style="color:#fbbf24;">üéØ Mimpi Besarmu?</span>
    <span class="section-tag" style="background:rgba(255,255,255,0.2); border-color:white; color:white;">Opsional</span>
  </div>
  <div style="font-size:11px; color:#e2e8f0; margin-bottom:12px;">
    Cek kecukupan dana untuk Rumah, Haji, Motor, dll.
  </div>
  <div class="dream-grid">
    <div>
      <select id="dreamType" style="padding:12px;">
        <option value="none">-- Pilih Aset --</option>
        <option value="rumah">Rumah (DP/Tunai)</option>
        <option value="motor">Motor</option>
        <option value="mobil">Mobil</option>
        <option value="haji">Daftar Haji</option>
        <option value="gadget">HP / Kamera / Laptop</option>
        <option value="liburan">Liburan</option>
      </select>
    </div>
    <div>
      <select id="dreamMethod" style="padding:12px;">
        <option value="tunai">100% Tunai</option>
        <option value="kredit">Kredit / KPR (DP 20%)</option>
      </select>
    </div>
  </div>
  <div class="dream-grid">
    <div>
      <input id="dreamPrice" type="text" placeholder="Estimasi Harga (Rp)" style="padding:12px;">
    </div>
  </div>
</div>

<label>Target Tercapai Tanggal (Opsional)</label>
<div class="input-group">
  <input id="targetDate" type="date">
  <div style="font-size:11px; color:#94a3b8; margin-top:8px; line-height:1.3; font-weight:600;">Contoh: Tanggal rencana nikah / HPL</div>
</div>

<button id="btn-calc" onclick="hitung()">
  <span class="spinner" id="btn-spinner"></span>
  <span id="btn-text">Hitung Keamanan</span>
</button>

<button id="unlock-btn" onclick="unlockForm()">‚úé Edit Data Ulang</button>
</div>

<!-- RIGHT CARD: RESULT -->
<div class="card">
<h2>Hasil Analisis</h2>

<div class="result-wrapper">
  <div class="big-label">Total Aset Aman Tercatat</div>
  <div class="big-value" id="emas">0 gram</div>
  <div class="sub-value">Dana yang bisa dikunci ke emas</div>
</div>

<div id="chart-container">
  <canvas id="chart"></canvas>
</div>

<!-- Detail Content -->
<div id="detail"></div>

<!-- CTA PRODUCTS -->
<div class="cta-group" id="btn-container" style="display:none;">
  <button class="cta" id="excelBtn">üì• Download Excel</button>
  <button class="cta" id="ebookBtn">üìò Panduan Emas (PDF)</button>
</div>

<!-- BANTUAN & DONASI -->
<div class="section-box" id="help-section" style="animation-delay: 0.5s; display:none;">
  <div class="section-title" style="font-size:14px;">
    <span style="color:#1e40af;">ü§ù Bantuan & Sedekah</span>
  </div>
  <div style="font-size:11px; color:#60a5fa; margin-bottom:10px;">
    Ada masalah mendesak atau ingin sedekah?
  </div>
  <div class="help-grid">
    <div class="help-btn-sm" onclick="bantu('Laptop Rusak')">üíª Laptop Rusak</div>
    <div class="help-btn-sm" onclick="bantu('Butuh Modal')">üíº Butuh Modal</div>
    <div class="help-btn-sm" onclick="bantu('Sakit Keluarga')">üè• Sakit Keluarga</div>
  </div>
  <button class="cta donate" onclick="donasi()" style="margin-top:12px; padding:10px;">‚ù§Ô∏è Donasi Pengembangan</button>
</div>

<div style="font-size: 11px; color: #94a3b8; text-align: center; margin-top: 20px; line-height: 1.4;">
  Data harga emas diupdate realtime (Logam Mulia)<br>
  <strong>Catatan:</strong> Ini adalah dana tujuan, bukan dana darurat.
</div>
</div>

</div>

<script>
let chart;
let animationFrameId; 

function formatIDR(x){return x.toLocaleString("id-ID");}

const setupFormatter = (id) => {
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener("input",e=>{
    let v=e.target.value.replace(/[^0-9]/g,"");
    e.target.value=v?parseInt(v).toLocaleString("id-ID"):"";
  });
};
setupFormatter("gajiPokok");
setupFormatter("sideHustle");
setupFormatter("debt");
setupFormatter("dreamPrice");

function unlockForm() {
  const inputSection = document.getElementById("input-section");
  const unlockBtn = document.getElementById("unlock-btn");
  const detailSection = document.getElementById("detail");
  
  inputSection.classList.remove("hidden-section");
  unlockBtn.style.display = "none";
  detailSection.style.display = "none"; // Reset view
}

function animateValue(obj, start, end, duration) {
  if (animationFrameId) cancelAnimationFrame(animationFrameId);
  let startTimestamp = null;
  const step = (timestamp) => {
    if (!startTimestamp) startTimestamp = timestamp;
    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
    obj.innerHTML = (progress * (end - start) + start).toFixed(2) + " gram";
    if (progress < 1) {
      animationFrameId = window.requestAnimationFrame(step);
    }
  };
  animationFrameId = window.requestAnimationFrame(step);
}

/* ===== SYSTEM LOGIC ===== */
function getCachedHarga(){
  try {
    const c=localStorage.getItem("harga_emas_cache");
    if(!c) return null;
    const o=JSON.parse(c);
    if(Date.now()-o.time>15*60*1000) return null;
    return o.price;
  } catch(e) { return null; }
}
function setCachedHarga(p){
  try {
    localStorage.setItem("harga_emas_cache",JSON.stringify({time:Date.now(),price:p}));
  } catch(e) {}
}

async function getHargaEmas(){
  const cached=getCachedHarga();
  const badge = document.getElementById("apiStatus");
  if(cached) {
    badge.innerText = "LIVE"; badge.classList.add("status-online");
    return cached;
  }
  badge.innerText = "Updating...";
  try{
    // Corrected API URL just in case
    const r=await fetch("https://logam-mulia-api.vercel.app/api/antam");
    const d=await r.json();
    setCachedHarga(d.buy);
    badge.innerText = "LIVE"; badge.classList.add("status-online");
    return d.buy;
  }catch(err){
    console.log("API Error:", err);
    badge.innerText = "OFFLINE"; badge.classList.remove("status-online");
    return getCachedHarga()||2652000; 
  }
}

window.onload=async ()=>{ await getHargaEmas(); };

function bantu(topik) {
  if(!confirm(`Apakah Anda ingin meminta bantuan untuk: ${topik}?`)) return;
  const text = encodeURIComponent(`Halo Admin, saya mengalami masalah: ${topik}. Mohon bantuannya.`);
  window.open("https://wa.me/6285123882845?text="+text);
}

function donasi() {
  if(!confirm(`Apakah Anda yakin ingin melakukan donasi pengembangan?`)) return;
  const text = encodeURIComponent("Assalamualaikum, saya ingin sedekah untuk pengembangan aplikasi HONORER DIGITAL.");
  window.open("https://wa.me/6285123882845?text="+text);
}

async function hitung(){
  try {
    // --- INPUT PARSING (SAFETY NET) ---
    const gajiPokokVal = document.getElementById("gajiPokok").value || "0";
    const sideHustleVal = document.getElementById("sideHustle").value || "0";
    const debtVal = document.getElementById("debt").value || "0";
    const dreamPriceVal = document.getElementById("dreamPrice").value || "0";

    const gajiPokok = Number(gajiPokokVal.replace(/[^0-9]/g,""));
    const sideHustle = Number(sideHustleVal.replace(/[^0-9]/g,""));
    const debt = Number(debtVal.replace(/[^0-9]/g,""));
    
    const dreamType = document.getElementById("dreamType").value;
    const dreamMethod = document.getElementById("dreamMethod").value;
    const dreamPrice = Number(dreamPriceVal.replace(/[^0-9]/g,""));

    const lifestyle = document.getElementById("lifestyle").value;
    const status = document.getElementById("status").value;
    const targetDateInput = document.getElementById("targetDate").value;
    
    // Total Income Logic
    const income = gajiPokok + sideHustle;
    
    // Validation
    if(!income || income === 0) {
      alert("Mohon isi penghasilan (Gaji Pokok atau Side Hustle) dengan benar.");
      document.getElementById("gajiPokok").focus();
      return;
    }

    // UI LOADING STATE
    const btn = document.getElementById("btn-calc");
    const btnText = document.getElementById("btn-text");
    const btnSpinner = document.getElementById("btn-spinner");
    const inputSection = document.getElementById("input-section");
    const unlockBtn = document.getElementById("unlock-btn");
    
    btn.disabled = true;
    btnText.innerText = "Menganalisis...";
    btnSpinner.style.display = "inline-block";

    // --- CORE CALCULATION ---
    const lifestyleFactor = { 'hemat': 0.8, 'standar': 1.0, 'mewah': 1.5 };
    const baseMult={nikah:6,hamil:4,anak:3};
    const targetRaw = income * baseMult[status];
    const target = Math.ceil(targetRaw * lifestyleFactor[lifestyle]); 
    const buffer = Math.ceil(income * 0.7 * 3);
    const aman = Math.max(0, target - buffer);

    // --- DREAM PLANNER LOGIC ---
    let dreamHTML = "";
    if (dreamType !== 'none' && dreamPrice > 0) {
      let requiredCash = 0;
      let feasibilityText = "";
      let feasibilityColor = "#10b981"; // Green
      let feasibilityLabel = "CUKUP AMAN";
      let advice = "";

      // Kalkulasi Kebutuhan Tunai
      if (dreamMethod === 'tunai') {
        requiredCash = dreamPrice;
        advice = "Belanja Tunai (Cash) adalah cara terbaik. Tidak ada beban di masa depan.";
      } else {
        // Kredit (DP 20%)
        requiredCash = dreamPrice * 0.2;
        advice = "Pastikan angsuran cicilan kurang dari 30% gaji.";
      }

      // Cek Kecukupan
      // Apakah Dana Aman (Emas) yang terkumpul cukup untuk membiayai mimpi ini?
      const diff = aman - requiredCash;

      if (diff >= 0) {
        feasibilityLabel = "CUKUP AMAN";
        feasibilityColor = "#10b981";
        advice = `Selamat! Dana Amanmu (${formatIDR(aman)}) cukup untuk ${dreamType} ini.`;
      } else {
        feasibilityLabel = "BELUM CUKUP";
        feasibilityColor = "#f59e0b"; // Orange
        const kekurangan = Math.abs(diff);
        advice = `Kurang Rp ${formatIDR(kekurangan)}. Anda bisa menabung tambahan atau menjual emas jika sudah butuh mendesak.`;
      }

      dreamHTML = `
      <div class="section-box" style="animation-delay: 0.05s; background:#fffbeb; border-color:#fcd34d;">
        <div class="section-title">
          <span style="color:#b45309;">üèÜ Cek Mimpi: ${dreamType.toUpperCase()}</span>
          <span class="section-tag" style="background:#fff; border-color:#f59e0b; color:#b45309;">${dreamMethod.toUpperCase()}</span>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:10px;">
          <div style="font-size:13px; color:#78350f;">Harga Perkiraan</div>
          <div style="font-size:18px; font-weight:800; color:#78350f;">Rp ${formatIDR(dreamPrice)}</div>
        </div>
        <div class="plan-row" style="color:#78350f; margin-bottom:5px;">
          <span>Kebutuhan Dana Tunai (DP/Lunas)</span>
          <strong>Rp ${formatIDR(requiredCash)}</strong>
        </div>
        <div class="dream-feasibility" style="color:${feasibilityColor};">${feasibilityLabel}</div>
        <div style="font-size:12px; color:#92400e; margin-top:5px;">${advice}</div>
      </div>`;
    }

    // --- MONTHLY ANALYSIS ---
    const needsMonthly = Math.ceil(income * 0.7);
    const savingsMonthly = income - needsMonthly - debt; 
    
    let harga = await getHargaEmas();
    if(!harga || harga === 0) harga = 2652000;
    
    const gram = aman / harga;
    animateValue(document.getElementById("emas"), 0, gram, 1000);

    const reason={
      nikah:["Biaya KUA & Legalitas Dokumen","Mahar/Seserahan","Biaya Akad & Pesta Sederhana","Pindahan & Uang Muka Tempat Tinggal","Perlengkapan Rumah Tangga","Biaya Hidup Bulan Pertama","Dana Cadangan Tak Terduga"],
      hamil:["Biaya Kontrol Rutin & USG","Suplemen & Nutrisi Ibu","Biaya Persalinan & RS","Biaya Dokter Spesialis","Perlengkapan Bayi Baru","Biaya Perawatan Pasca Melahirkan","Dana Darurat Komplikasi"],
      anak:["Biaya Rutin Susu & Makanan","Imunisasi & Kesehatan","Perlengkapan Anak","Biaya Pendidikan Awal","Transportasi & Aktivitas","Biaya Hidup Tambahan","Dana Sakit Anak"]
    };

    const list = reason[status].map(x=>"<li>"+x+"</li>").join("");
    const lifestyleLabel = lifestyle.charAt(0).toUpperCase() + lifestyle.slice(1);

    // --- TARGET DATE LOGIC ---
    let targetPlanHTML = "";
    let targetMonthlySaving = 0;

    if (targetDateInput) {
      const diffMonths = Math.ceil((new Date(targetDateInput) - new Date()) / (1000 * 60 * 60 * 24 * 30));

      if (diffMonths <= 0) {
         targetPlanHTML = `<div class="plan-box" style="background:#fee2e2; border-color:#fca5a5;"><div style="color:#b91c1c; font-weight:bold; font-size:13px;">Waktu Terlampaui</div><div style="font-size:11px; color:#991b1b;">Tanggal target sudah lewat.</div></div>`;
      } else {
         const tabunganPerBulan = Math.ceil(aman / diffMonths);
         targetMonthlySaving = tabunganPerBulan;
         
         const dailyTarget = Math.ceil(tabunganPerBulan / 30);
         const weeklyTarget = Math.ceil(tabunganPerBulan / 4);
         
         let contextText = "";
         if (dailyTarget < 25000) contextText = "Setara dengan 1 botol air minum.";
         else if (dailyTarget < 50000) contextText = "Setara dengan 1x jajan snack kecil.";
         else if (dailyTarget < 75000) contextText = "Setara dengan 1x makan siang warteg.";
         else contextText = "Hemat sedikit saja dari uang jajan/harian.";

         targetPlanHTML = `
         <div class="plan-box">
           <div class="plan-row"><span>Target Tanggal:</span> <strong>${new Date(targetDateInput).toLocaleDateString('id-ID')}</strong></div>
           <div class="plan-row"><span>Sisa Waktu:</span> <strong>${diffMonths} Bulan</strong></div>
           
           <div class="action-plan-box">
             <span class="action-header">üî• Langkah Nyata Harian</span>
             <div class="action-grid">
               <div class="action-item">
                 <span class="action-label">Target Harian</span>
                 <span class="action-val">Rp ${formatIDR(dailyTarget)}</span>
               </div>
               <div class="action-item">
                 <span class="action-label">Target Mingguan</span>
                 <span class="action-val">Rp ${formatIDR(weeklyTarget)}</span>
               </div>
             </div>
             <div class="action-tip">
               ${contextText}
             </div>
           </div>

           <div class="plan-row highlight">
             <span>Total Bulanan:</span> <span>Rp ${formatIDR(tabunganPerBulan)} / bln</span>
           </div>
           <div class="footnote">
             *Bandingkan dengan Kemampuanmu (Rp ${formatIDR(savingsMonthly)}).
           </div>
         </div>`;
      }
    } else {
      const cicil6 = aman/6; const cicil12 = aman/12;
      targetPlanHTML = `
      <div class="plan-box" style="background:#f8fafc; border-color:#e2e8f0;">
        <div style="font-size:11px; color:#64748b; margin-bottom:6px; font-weight:600;">Simulasi Tabungan Emas (Umum)</div>
        <div class="plan-row"><span>6 Bulan:</span> <strong>Rp ${formatIDR(Math.ceil(cicil6))} / bln</strong></div>
        <div class="plan-row"><span>12 Bulan:</span> <strong>Rp ${formatIDR(Math.ceil(cicil12))} / bln</strong></div>
      </div>`;
    }

    // --- WARNING & ADVICE LOGIC ---
    let warningHTML = "";
    let isDeficit = (needsMonthly + debt) > income; 
    let dailyAdviceText = "";

    if (isDeficit) {
      if (status === 'anak') {
        warningHTML = `
        <div class="section-box danger-box" style="animation-delay: 0.1s; border:2px solid #fca5a5;">
          <div class="section-title"><span style="color:#b91c1c;">‚ö†Ô∏è KRISIS PENGHASILAN KELUARGA</span></div>
          <div class="section-desc" style="color:#991b1b; font-weight:600;">
            Pengeluaranmu (${formatIDR(needsMonthly + debt)}) melebihi gaji (${formatIDR(income)}). <br><br>
            Karena sudah punya anak (tanggungan), sangat tidak disarankan untuk mengurangi makan atau biaya sekolah. <br><br>
            <strong>SOLUSI WAJIB: Segera cari penghasilan tambahan (Side Hustle).</strong>
          </div>
        </div>`;
      } else {
        warningHTML = `
        <div class="section-box danger-box" style="animation-delay: 0.1s; border:2px solid #fca5a5;">
          <div class="section-title"><span style="color:#b91c1c;">‚ö†Ô∏è PERINGATAN KRITIS</span></div>
          <div class="section-desc" style="color:#991b1b; font-weight:600;">
            Pengeluaranmu (${formatIDR(needsMonthly + debt)}) melebihi gaji (${formatIDR(income)}). Kamu sedang berada di zona merah. <br><br>
            Segera kurangi gaya hidup atau cari sumber pendapatan tambahan.
          </div>
        </div>`;
      }
    } else if (targetMonthlySaving > savingsMonthly && targetDateInput) {
      const gap = targetMonthlySaving - savingsMonthly;
      
      if (status === 'anak') {
        warningHTML = `
        <div class="section-box warning-box" style="animation-delay: 0.1s;">
          <div class="section-title"><span style="color:#b45309;">‚ö†Ô∏è TARGET TABUNGAN KURANG</span></div>
          <div class="section-desc" style="color:#92400e;">
            Target tabunganmu (${formatIDR(targetMonthlySaving)}/bln) lebih besar dari kemampuan nabung nyatamu (${formatIDR(savingsMonthly)}/bln). <br>
            <strong>Defisit:</strong> Rp ${formatIDR(gap)}/bln.<br><br>
            Solusi: Cari penghasilan tambahan atau pilih sekolah/sehatan yang lebih hemat.
          </div>
        </div>`;
      } else {
        warningHTML = `
        <div class="section-box warning-box" style="animation-delay: 0.1s;">
          <div class="section-title"><span style="color:#b45309;">‚ö†Ô∏è TARGET TERLALU BERAT</span></div>
          <div class="section-desc" style="color:#92400e;">
            Target tabunganmu (${formatIDR(targetMonthlySaving)}/bln) lebih besar dari kemampuan nabung nyatamu (${formatIDR(savingsMonthly)}/bln). <br>
            <strong>Defisit:</strong> Rp ${formatIDR(gap)}/bln.<br><br>
            Solusi: Tunda target tanggal atau kurangi gaya hidup (Ganti jadi "Hemat").
          </div>
        </div>`;
      }
    }

    // Advice Text Logic
    if (status === 'nikah') {
      dailyAdviceText = "Jangan buru beli barang dekorasi mahal hari ini. Nabung Rp 50rb untuk mahar atau beli logam mulia lebih penting untuk masa depanmu.";
    } else if (status === 'hamil') {
      dailyAdviceText = "Nutrisi dan vitamin Ibu adalah prioritas. Jangan ambil dari tabungan emas. Hemat jajan kecil untuk vitaminnya.";
    } else {
      dailyAdviceText = "Mainan anak tidak harus selalu baru. Kualitas waktu mainkan mereka lebih berharga. Nabungkan Rp 20rb hari ini sebagai awal tabungan sekolah.";
    }

    // --- RENDER HTML ---
    document.getElementById("detail").style.display = "block";
    
    document.getElementById("detail").innerHTML=`
<!-- ADVICE -->
<div class="advice-box" style="animation-delay: 0.05s;">
  <strong style="font-size:14px; display:block; margin-bottom:4px;">üí° Nasehat Harianmu</strong>
  ${dailyAdviceText}
</div>

 ${warningHTML}

 ${dreamHTML}

<!-- ANALISA BULANAN -->
<div class="section-box" style="animation-delay: 0.15s;">
  <div class="section-title">
    Analisa Bulanan
    <span class="section-tag tag-blue">Cash Flow</span>
  </div>
  <div class="section-desc" style="margin-bottom:12px;">
    Total Penghasilan: <strong>Rp ${formatIDR(income)}</strong> (Gaji + Bonus)
  </div>
  <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:600; margin-bottom:4px;">
    <span style="color:#1e40af;">Kebutuhan Hidup</span>
    <span>${formatIDR(needsMonthly)} (${Math.round((needsMonthly/income)*100)}%)</span>
  </div>
  <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:600; margin-bottom:4px;">
    <span style="color:#b91c1c;">Cicilan / Utang</span>
    <span>${formatIDR(debt)} (${Math.round((debt/income)*100)}%)</span>
  </div>
  <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:600; margin-bottom:8px; border-top:1px dashed #cbd5e1; padding-top:4px;">
    <span style="color:#059669;">Kemampuan Menabung (Nyata)</span>
    <span>${formatIDR(savingsMonthly)} (${100 - Math.round((needsMonthly/income)*100) - Math.round((debt/income)*100)}%)</span>
  </div>
  ${!isDeficit ? `
  <div class="progress-bar-container">
    <div class="progress-segment seg-hidup" style="width:${Math.round((needsMonthly/income)*100)}%"></div>
    <div class="progress-segment seg-utang" style="width:${Math.round((debt/income)*100)}%"></div>
    <div class="progress-segment seg-sisa" style="width:${100 - Math.round((needsMonthly/income)*100) - Math.round((debt/income)*100)}%"></div>
  </div>` : ''}
</div>

<!-- DANA PENYANGGA -->
<div class="section-box highlight-box" style="animation-delay: 0.2s;">
  <div class="section-title">
    Dana Penyangga Hidup
    <span class="section-tag tag-yellow">Wajib Tunai</span>
  </div>
  <div class="section-price" style="color:var(--primary-dark);">Rp ${formatIDR(buffer)}</div>
  <div class="section-desc">
    Uang tunai ini wajib ada di rekening. Ini adalah sabuk pengaman keuanganmu. Jika penghasilan berhenti (sakit/cuti/resign), uang ini menutup kebutuhan makan & sewa selama 3 bulan.
  </div>
</div>

<!-- DANA BESAR -->
<div class="section-box" style="animation-delay: 0.25s;">
  <div class="section-title">
    Kebutuhan Dana Besar
    <span class="section-tag tag-yellow">Gaya Hidup ${lifestyleLabel}</span>
  </div>
  <div class="section-price">Rp ${formatIDR(target)}</div>
  <div class="section-desc">
    Estimasi biaya realistis dengan gaya hidup <strong>${lifestyleLabel}</strong>.
    <ul style="margin: 8px 0 0 0; padding-left: 14px; color: var(--text-muted); font-size: 12px;">${list}</ul>
  </div>
</div>

<!-- DANA DIKUNCI -->
<div class="section-box" style="animation-delay: 0.3s; background: #fff; border: 1px solid #d1fae5;">
  <div class="section-title">
    Dana Siap Dikunci
    <span class="section-tag tag-green">Bisa di Emas</span>
  </div>
  <div class="section-price" style="color:var(--success-dark);">Rp ${formatIDR(aman)}</div>
  <div class="section-desc">
    Ini adalah sisa dana dari total kebutuhan yang aman untuk dikunci (diinvestasikan) dalam bentuk emas.
    <br><br>
    <strong>Setara emas:</strong> ${gram.toFixed(2)} gram<br>
    <strong>Harga emas:</strong> Rp ${formatIDR(harga)} / gram
  </div>
  ${targetPlanHTML}
</div>
`;

    // --- CHART LOGIC ---
    const data = [aman, buffer];
    if(chart) chart.destroy();
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx,{
      type:"doughnut",
      data:{
        labels:["Aman (Emas)","Penyangga (Tunai)"],
        datasets:[{ data:data, backgroundColor: ["#10b981", "#fbbf24"], borderWidth:0, hoverOffset: 6 }]
      },
      options: {
        cutout: '78%', responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, font: {size: 11, family: 'Plus Jakarta Sans'} } } },
        animation: { animateScale: true, animateRotate: true, duration: 1500, easing: 'easeOutQuart' }
      }
    });

    // --- LOCAL STORAGE ---
    localStorage.setItem("honorer_kalkulasi",JSON.stringify({
      status, gajiPokok, sideHustle, debt, lifestyle, dreamType, dreamMethod, dreamPrice,
      targetDate:targetDateInput, target, buffer, aman, gram, harga
    }));

    // --- SHOW BUTTONS & LOCK UI ---
    inputSection.classList.add('hidden-section');
    unlockBtn.style.display = "block";
    document.getElementById("btn-container").style.display = "grid";
    document.getElementById("help-section").style.display = "block";

    // --- WA LINKS ---
    const fullWaText = encodeURIComponent(
`HONORER DIGITAL - PRO PLAN

DATA INPUT:
- Status: ${status}
- Penghasilan: Rp ${formatIDR(income)} (Gaji+Bonus)
- Gaya Hidup: ${lifestyleLabel}
- Cicilan/Utang: Rp ${formatIDR(debt)}

HASIL PERHITUNGAN:
1. Kebutuhan Dana Besar: Rp ${formatIDR(target)}
2. Dana Penyangga: Rp ${formatIDR(buffer)}
3. Dana Aman: Rp ${formatIDR(aman)}
   Setara: ${gram.toFixed(2)} gram

RENCANA TABUNGAN:
 ${targetDateInput ? `- Target: ${new Date(targetDateInput).toLocaleDateString('id-ID')}\n- Tabungan Emas: Rp ${formatIDR(Math.ceil(aman/Math.ceil((new Date(targetDateInput)-new Date())/(1000*60*60*24*30))))} / bln` : '- Umum'}`);

    document.getElementById("waBtn") = {
      onclick: () => window.open("https://wa.me/6285123882845?text="+fullWaText) // Assuming waBtn for general share or order
    };
    // Assign buttons if they exist in HTML (In my previous code I added separate buttons for sales)
    const excelBtn = document.getElementById("excelBtn");
    const ebookBtn = document.getElementById("ebookBtn");

    if(excelBtn) {
      const waExcel = `Halo, saya ingin order "Template Excel Pengatur Keuangan Keluarga" (Rp 49.000). \n\nBerikut data analisa saya:\n${fullWaText}`;
      excelBtn.onclick = () => window.open("https://wa.me/6285123882845?text=" + encodeURIComponent(waExcel));
    }
    if(ebookBtn) {
      const waBook = `Halo, saya ingin order "Panduan Beli Emas (E-Book)" (Rp 29.000).\n\nMohon infonya.`;
      ebookBtn.onclick = () => window.open("https://wa.me/6285123882845?text=" + encodeURIComponent(waBook));
    }

    // --- RESET BUTTON ---
    btn.disabled = false;
    btnText.innerText = "Hitung Keamanan";
    btnSpinner.style.display = "none";

  } catch (error) {
    console.error("Critical Error:", error);
    alert("Terjadi Kesalahan Sistem: " + error.message);
    
    // Reset UI on Error
    const btn = document.getElementById("btn-calc");
    const btnText = document.getElementById("btn-text");
    const btnSpinner = document.getElementById("btn-spinner");
    if(btn) {
      btn.disabled = false;
      btnText.innerText = "Hitung Keamanan";
      btnSpinner.style.display = "none";
    }
  }
}
</script>
</body>
</html>
